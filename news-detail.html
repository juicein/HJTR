<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>加载中...</title>

  <!-- 默认 OG 标签 -->
  <meta property="og:title" content="加载中..." />
  <meta property="og:description" content="正在加载新闻..." />
  <meta property="og:image" content="" />
  <meta property="og:type" content="article" />
  <meta property="og:url" content="" />

  <!-- 样式 -->
  <link rel="stylesheet" href="../assets/style.css" />
  <style>
    body {
      max-width: 900px;
      margin: 30px auto;
      padding: 0 15px;
      font-family: "微软雅黑", sans-serif;
    }
    .back-link {
      display: inline-block;
      margin-bottom: 20px;
      color: #0077cc;
      text-decoration: none;
    }
    .news-title {
      font-size: 2em;
      margin-bottom: 10px;
    }
    .news-meta {
      color: #666;
      margin-bottom: 10px;
    }
    .view-count {
      color: #999;
      font-size: 0.9em;
      margin-bottom: 20px;
    }
    .news-image {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      margin-bottom: 20px;
      display: block;
    }
    .news-content {
      white-space: pre-wrap;
      line-height: 1.6;
      font-size: 1.1em;
    }
    /* 分享按钮样式 */
    .share-container {
      margin-top: 40px;
      border-top: 1px solid #eee;
      padding-top: 15px;
    }
    .share-title {
      margin-bottom: 10px;
      font-weight: bold;
    }
    .share-buttons a {
      display: inline-block;
      margin-right: 10px;
      text-decoration: none;
      color: #fff;
      padding: 8px 14px;
      border-radius: 20px;
      font-size: 0.9em;
    }
    .share-weibo { background: #E6162D; }
    .share-twitter { background: #1DA1F2; }
    .share-facebook { background: #4267B2; }
    .share-qq { background: #12B7F5; }
    .share-wechat { background: #1AAD19; }

    /* 微信弹窗 */
    #wechat-popup {
      display:none;
      position:fixed;
      top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.6);
      justify-content:center;
      align-items:center;
      z-index: 9999;
    }
    #wechat-popup .popup-content {
      background:#fff;
      padding:20px;
      border-radius:8px;
      text-align:center;
    }
    #wechat-popup button {
      margin-top:10px;
      padding:6px 12px;
      background:#666;
      color:#fff;
      border:none;
      border-radius:4px;
      cursor:pointer;
    }
  </style>

  <!-- 引入二维码库 -->
  <script src="https://cdn.jsdelivr.net/npm/qrious/dist/qrious.min.js"></script>
</head>
<body>
  <a href="../index.html" class="back-link">← 返回新闻列表</a>

  <h1 id="title" class="news-title">加载中...</h1>
  <div id="meta" class="news-meta"></div>
  <div id="views" class="view-count"></div> <!-- 浏览量显示 -->
  <img id="image" class="news-image" src="" alt="" style="display:none" />
  <div id="content" class="news-content"></div>

  <!-- 分享区 -->
  <div class="share-container">
    <div class="share-title">📢 分享到：</div>
    <div class="share-buttons">
      <a id="share-weibo" class="share-weibo" target="_blank">微博</a>
      <a id="share-twitter" class="share-twitter" target="_blank">Twitter</a>
      <a id="share-facebook" class="share-facebook" target="_blank">Facebook</a>
      <a id="share-qq" class="share-qq" target="_blank">QQ</a>
      <a id="share-wechat" class="share-wechat">微信</a>
    </div>
  </div>

  <!-- 微信二维码弹窗 -->
  <div id="wechat-popup">
    <div class="popup-content">
      <p style="margin-bottom:10px; font-weight:bold;">📱 扫码分享到微信</p>
      <canvas id="wechat-qrcode"></canvas>
      <br />
      <button onclick="document.getElementById('wechat-popup').style.display='none'">关闭</button>
    </div>
  </div>

  <script>
    function getQueryId() {
      const params = new URLSearchParams(window.location.search);
      return params.get('id');
    }

    const newsId = getQueryId();

    if (newsId === null) {
      document.getElementById('title').textContent = '错误：未指定新闻ID';
    } else {
      fetch('../news_content.json')
        .then(res => res.json())
        .then(news => {
          if (newsId < 0 || newsId >= news.length) {
            document.getElementById('title').textContent = '新闻不存在';
            return;
          }
          const item = news[newsId];

          // 设置页面标题
          document.title = item.title;

          // 设置 OG 标签
          document.querySelector('meta[property="og:title"]').setAttribute('content', item.title);
          document.querySelector('meta[property="og:description"]').setAttribute('content', item.content.substring(0, 80) + "...");
          if (item.image && item.image.trim() !== '') {
            document.querySelector('meta[property="og:image"]').setAttribute('content', item.image);
          }
          document.querySelector('meta[property="og:url"]').setAttribute('content', window.location.href);

          // 填充正文
          document.getElementById('title').textContent = item.title;
          document.getElementById('meta').textContent = `${item.date} · ${item.location} · 作者：${item.author}`;

          if (item.image && item.image.trim() !== '') {
            const img = document.getElementById('image');
            if (item.image.startsWith('#')) {
              img.style.display = 'none';
              const colorDiv = document.createElement('div');
              colorDiv.style.width = '100%';
              colorDiv.style.height = '200px';
              colorDiv.style.backgroundColor = item.image;
              colorDiv.style.borderRadius = '8px';
              colorDiv.style.marginBottom = '20px';
              img.parentNode.insertBefore(colorDiv, img);
            } else {
              img.src = item.image;
              img.style.display = 'block';
            }
          }

          document.getElementById('content').textContent = item.content;

          /* 📊 浏览量统计（LocalStorage 实现） */
          let viewsKey = "views_" + newsId;
          let count = localStorage.getItem(viewsKey) || 0;
          count++;
          localStorage.setItem(viewsKey, count);
          document.getElementById('views').textContent = `👁️ 浏览量：${count}`;

          /* 🔗 设置分享链接 */
          const url = encodeURIComponent(window.location.href);
          const text = encodeURIComponent(item.title);

          document.getElementById("share-weibo").href =
            `https://service.weibo.com/share/share.php?title=${text}&url=${url}`;
          document.getElementById("share-twitter").href =
            `https://twitter.com/intent/tweet?text=${text}&url=${url}`;
          document.getElementById("share-facebook").href =
            `https://www.facebook.com/sharer/sharer.php?u=${url}`;
          document.getElementById("share-qq").href =
            `https://connect.qq.com/widget/shareqq/index.html?url=${url}&title=${text}&desc=${text}&pics=${encodeURIComponent(item.image || '')}`;

          /* 微信分享（二维码弹窗） */
          document.getElementById("share-wechat").addEventListener("click", function() {
            const popup = document.getElementById("wechat-popup");
            popup.style.display = "flex";

            // 生成二维码
            const canvas = document.getElementById("wechat-qrcode");
            canvas.innerHTML = ""; // 清空
            new QRious({
              element: canvas,
              value: window.location.href,
              size: 200
            });
          });
        })
        .catch(() => {
          document.getElementById('title').textContent = '加载失败，请稍后重试';
        });
    }
  </script>
</body>
</html>

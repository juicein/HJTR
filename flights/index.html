<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>航班时刻表</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="assets/style.css">
  <script src="flights.js"></script>
</head>
<body>
  <header>
    <h1>航班时刻表</h1>
  </header>

  <!-- 筛选栏 -->
  <div class="filters">
    <input type="text" id="fromAirport" placeholder="出发机场">
    <input type="text" id="toAirport" placeholder="到达机场">
    <button onclick="searchFlights()">搜索</button>
    <button onclick="showSingleAirport()">只看某机场</button>

    <select id="timeFilter">
      <option value="">时间段</option>
      <option value="0-6">凌晨 (0-6)</option>
      <option value="6-12">上午 (6-12)</option>
      <option value="12-14">中午 (12-14)</option>
      <option value="14-18">下午 (14-18)</option>
      <option value="18-24">晚上 (18-24)</option>
    </select>

    <select id="airlineFilter">
      <option value="">航空公司</option>
    </select>

    <input type="date" id="datePicker" onchange="searchFlights()">
  </div>

  <!-- 航班展示区 -->
  <div id="flightsContainer" class="cards"></div>

  <script>
    // 星期映射
    const weekMap = ["SUN","MON","TUE","WED","THU","FRI","SAT"];

    // 初始化日期默认值为今天
    const today = new Date();
    document.getElementById("datePicker").value = today.toISOString().split("T")[0];

    // 从原始字符串解析航班数据
    function parseFlight(str){
      const id = str.match(/【(.*?)】/)[1];
      const week = str.match(/«(.*?)»/)[1].split(",");
      const plane = str.match(/〔(.*?)〕/)[1];
      const airline = str.match(/『(.*?)』/)[1];
      const from = str.match(/《(.*?)出发》/)[1];
      const to = str.match(/《(.*?)到达》/)[1];
      const dep = str.match(/出发》{(.*?)}/)[1];
      const depDay = parseInt(str.match(/出发》.*#\+(\d+)#/)[1]);
      const depTerminal = str.match(/出发》.*@(.*?)@/)[1];
      const arr = str.match(/到达》{(.*?)}/)[1];
      const arrDay = parseInt(str.match(/到达》.*#\+(\d+)#/)[1]);
      const arrTerminal = str.match(/到达》.*@(.*?)@/)[1];
      const economy = str.match(/§(.*?)元§/)[1];
      const businessMatch = str.match(/θ(.*?)元θ/);
      const business = businessMatch ? businessMatch[1] : "";

      return {id,week,plane,airline,from,to,dep,depDay,depTerminal,arr,arrDay,arrTerminal,economy,business};
    }

    // 把字符串数据转为对象
    const flightData = flights.map(parseFlight);

    // 初始化航空公司选项
    const airlines = [...new Set(flightData.map(f=>f.airline))];
    const airlineFilter = document.getElementById("airlineFilter");
    airlines.forEach(a=>{
      let opt=document.createElement("option");
      opt.value=a; opt.innerText=a;
      airlineFilter.appendChild(opt);
    });

    // 搜索逻辑
    function searchFlights(){
      const from = document.getElementById("fromAirport").value.trim();
      const to = document.getElementById("toAirport").value.trim();
      const timeRange = document.getElementById("timeFilter").value;
      const airline = document.getElementById("airlineFilter").value;
      const date = document.getElementById("datePicker").value;
      const week = weekMap[new Date(date).getDay()];

      let result = flightData.filter(f=>{
        if(!f.week.includes(week)) return false;
        if(from && !f.from.includes(from)) return false;
        if(to && !f.to.includes(to)) return false;
        if(airline && f.airline!==airline) return false;
        if(timeRange){
          const [s,e]=timeRange.split("-").map(Number);
          const h=parseInt(f.dep.split(":")[0]);
          if(h<s || h>=e) return false;
        }
        return true;
      });
      renderFlights(result);
    }

    // 只看某机场
    function showSingleAirport(){
      const from = document.getElementById("fromAirport").value.trim();
      if(!from) return alert("请输入一个机场名称");
      let result = flightData.filter(f=>(f.from.includes(from)||f.to.includes(from)));
      renderFlights(result);
    }

    // 渲染卡片
    function renderFlights(list){
      const container=document.getElementById("flightsContainer");
      container.innerHTML="";
      if(list.length===0){
        container.innerHTML="<p>没有符合条件的航班</p>";
        return;
      }
      list.forEach(f=>{
        let card=document.createElement("div");
        card.className="card";
        card.innerHTML=`
          <h3>${f.id} - ${f.airline}</h3>
          <p><strong>${f.from}</strong> ${f.dep} (Day+${f.depDay}, ${f.depTerminal}) → 
             <strong>${f.to}</strong> ${f.arr} (Day+${f.arrDay}, ${f.arrTerminal})</p>
          <p>机型：${f.plane}</p>
          <p>经济舱：${f.economy} 元 | 商务舱：${f.business||"无"} 元</p>
        `;
        container.appendChild(card);
      });
    }

    // 初始加载
    searchFlights();
  </script>
</body>
</html>

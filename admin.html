<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>HJTR 管理系统</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
<style>
body{font-family:Roboto;background:#f6f2ff;margin:0;padding:20px}
.card{background:#fff;border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 4px 12px rgba(0,0,0,.1)}
button{background:#6750A4;color:#fff;border:none;padding:8px 16px;border-radius:8px}
input,textarea{width:100%;padding:8px;margin:6px 0;border-radius:8px;border:1px solid #ccc}
#app{max-width:900px;margin:auto}
</style>
</head>
<body>
<div id="app"></div>

<script>
const API="你的worker地址"
let TOKEN=""
let DATA=[]

function renderLogin(){
app.innerHTML=`
<div class="card">
<h2>登录</h2>
<input id="name" placeholder="名称">
<input id="pass" type="password" placeholder="密码">
<button onclick="login()">登录</button>
</div>`
}

async function login(){
const r=await fetch(API+"/login",{method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({name:name.value,password:pass.value})})
const d=await r.json()
if(!d.token) return alert("失败")
TOKEN=d.token
loadData()
}

async function loadData(){
const r=await fetch(API+"/routes",{headers:{Authorization:"Bearer "+TOKEN}})
DATA=await r.json()
renderMain()
}

function renderMain(){
app.innerHTML=`
<button onclick="renderAdd()">新增线路</button>
<input placeholder="搜索" oninput="search(this.value)">
<div id="list"></div>`
renderList(DATA)
}

function renderList(arr){
list.innerHTML=""
arr.forEach((l,i)=>{
list.innerHTML+=`
<div class="card">
<b>${l.name} ｜ ${l.type}</b><br>
${l.stations[0]} → ${l.stations[l.stations.length-1]}<br>
${l.company}
<br><button onclick="edit(${i})">修改</button>
<button onclick="del(${i})">删除</button>
</div>`
})
}

function search(v){
renderList(DATA.filter(l=>l.name.includes(v)))
}

function renderAdd(){
app.innerHTML=`
<div class="card">
<h3>新增</h3>
<input id="n" placeholder="线路名">
<textarea id="s" placeholder="站点用-分隔"></textarea>
<input id="c" placeholder="公司">
<input id="r" placeholder="地区">
<input id="t" placeholder="类型">
<input id="st" placeholder="首班">
<input id="ed" placeholder="末班">
<input id="p" placeholder="票价">
<button onclick="saveNew()">保存</button>
</div>`
}

function saveNew(){
DATA.push({
name:n.value,
stations:s.value.split("-"),
company:c.value,
region:r.value,
type:t.value,
start:st.value,
end:ed.value,
price:p.value
})
saveAll()
}

function edit(i){
const l=DATA[i]
renderAdd()
n.value=l.name
s.value=l.stations.join("-")
c.value=l.company
r.value=l.region
t.value=l.type
st.value=l.start
ed.value=l.end
p.value=l.price
DATA.splice(i,1)
}

function del(i){
if(confirm("确认删除？")){
DATA.splice(i,1)
saveAll()
}
}

async function saveAll(){
await fetch(API+"/save",{
method:"POST",
headers:{
"Content-Type":"application/json",
Authorization:"Bearer "+TOKEN
},
body:JSON.stringify({data:DATA})
})
loadData()
}

renderLogin()
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>HJTR 公交管理系统</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{margin:0;font-family:system-ui;background:#eef3f8}
header{background:#003f6b;color:#fff;padding:16px;font-size:18px}
.container{max-width:1200px;margin:auto;padding:20px}
.card{
  background:#fff;
  padding:15px;
  border-radius:12px;
  margin-bottom:15px;
  box-shadow:0 3px 10px rgba(0,0,0,0.08)
}
input{width:100%;padding:6px;margin:4px 0}
button{
  padding:6px 12px;
  border:none;
  border-radius:8px;
  background:#006495;
  color:#fff;
  cursor:pointer;
  margin-right:6px;
}
#loginBox{
  max-width:400px;
  margin:120px auto;
  background:#fff;
  padding:20px;
  border-radius:12px;
}
.topbar{
  display:flex;
  justify-content:space-between;
  margin-bottom:15px;
}
</style>
</head>

<body>

<header>HJTR 公交理系统</header>

<div id="loginBox">
  <h3>管理员登录</h3>
  <input id="username" placeholder="名称">
  <input id="password" type="password" placeholder="密码">
  <button onclick="login()">登录</button>
</div>

<div class="container" id="app" hidden>
  <div class="topbar">
    <div id="roleInfo"></div>
    <div>
      <button onclick="addLine()">新增</button>
      <button onclick="saveAll()">保存</button>
      <button onclick="logout()">退出</button>
    </div>
  </div>
  <div id="list"></div>
</div>

<script>

const API="https://orange-king-0a98-hjtr-bus-api.1693076637.workers.dev";

let role=null;
let allLines=[];
let visibleLines=[];

async function login(){

  const user=username.value;
  const pass=password.value;

  const res=await fetch(API+"/login",{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({username:user,password:pass})
  });

  if(res.status===401){
    alert("密码错误");
    return;
  }

  role=await res.json();

  localStorage.setItem("user",user);
  localStorage.setItem("pass",pass);

  loadData();
}

function logout(){
  localStorage.clear();
  location.reload();
}

async function loadData(){

  const res=await fetch(API);
  const text=await res.text();

  allLines=text.split("\n").filter(x=>x.trim());

  filterLines();

  loginBox.hidden=true;
  app.hidden=false;

  roleInfo.innerText="身份："+role.type+"："+role.name;

  render();
}

function filterLines(){

  if(role.type==="super"){
    visibleLines=[...allLines];
    return;
  }

  visibleLines=allLines.filter(line=>{
    if(role.type==="company")
      return line.includes(`{${role.name}}`);
    if(role.type==="region")
      return line.includes(`『${role.name}』`);
  });
}

function render(){

  list.innerHTML="";

  visibleLines.forEach((line,i)=>{

    const name=line.match(/【(.+?)】/)?.[1]||"";
    const company=line.match(/\{(.+?)\}/)?.[1]||"";
    const region=line.match(/『(.+?)』/)?.[1]||"";
    const type=line.match(/θ(.+?)θ/)?.[1]||"";

    const card=document.createElement("div");
    card.className="card";

    card.innerHTML=`
      <label>线路名</label>
      <input id="n${i}" value="${name}">
      <label>公司</label>
      <input id="c${i}" value="${company}">
      <label>地区</label>
      <input id="r${i}" value="${region}">
      <label>类型</label>
      <input id="t${i}" value="${type}">
      <br>
      <button onclick="updateLine(${i})">修改</button>
      <button onclick="deleteLine(${i})">删除</button>
    `;

    list.appendChild(card);
  });
}

function rebuildAll(){

  if(role.type==="super"){
    allLines=[...visibleLines];
    return;
  }

  allLines=allLines.filter(line=>{
    if(role.type==="company")
      return !line.includes(`{${role.name}}`);
    if(role.type==="region")
      return !line.includes(`『${role.name}』`);
  });

  allLines=[...allLines,...visibleLines];
}

function updateLine(i){

  const n=document.getElementById("n"+i).value;
  const c=document.getElementById("c"+i).value;
  const r=document.getElementById("r"+i).value;
  const t=document.getElementById("t"+i).value;

  visibleLines[i]=
  `【${n}】起点-终点-{${c}}《票价888元》『${r}』θ${t}θ§6:00§@22:30@`;

  rebuildAll();
  render();
}

function deleteLine(i){
  visibleLines.splice(i,1);
  rebuildAll();
  render();
}

function addLine(){

  const newline=
  `【新线路】起点-终点-{${role.type==="company"?role.name:"公司"}}《票价888元》『${role.type==="region"?role.name:"地区"}』θ公交θ§6:00§@22:30@`;

  visibleLines.push(newline);

  rebuildAll();
  render();
}

async function saveAll(){

  const user=localStorage.getItem("user");
  const pass=localStorage.getItem("pass");

  const res=await fetch(API+"/save",{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      username:user,
      password:pass,
      content:allLines.join("\n")
    })
  });

  if(res.ok) alert("保存成功");
  else alert("保存失败");
}

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>公交管理系统</title>

<style>
body{font-family:system-ui;background:#f7f7f7;padding:16px}
h2{font-weight:500}
.card{
  background:#fff;
  margin-bottom:16px;
  padding:16px;
  border-radius:12px;
  box-shadow:0 3px 8px rgba(0,0,0,0.08);
}
input,select{
  width:100%;
  padding:8px;
  margin:6px 0;
  border-radius:6px;
  border:1px solid #ccc;
}
button{
  padding:8px 14px;
  border:none;border-radius:20px;
  background:#6750A4;color:white;
  cursor:pointer;
  margin:4px;
}
button.delete{background:#B3261E}
.station{display:flex;gap:6px;margin-bottom:5px;}
.station input{flex:1}
</style>
</head>
<body>

<h2>公交管理系统</h2>

<div id="login" class="card">
  <input id="pwd" placeholder="请输入管理员口令">
  <button onclick="login()">登录</button>
</div>

<div id="main" style="display:none">
  <button onclick="addLine()">新增线路</button>
  <div id="list"></div>
</div>

<script>

const API="https://orange-king-0a98-hjtr-bus-api.1693076637.workers.dev";

let rawText="";
let lines=[];
let role="";
let roleValue="";

function parseLine(text){

  const name = text.match(/【(.+?)】/)?.[1] || "";
  const company = text.match(/\{(.+?)\}/)?.[1] || "";
  const region = text.match(/『(.+?)』/)?.[1] || "";
  const type = text.match(/θ(.+?)θ/)?.[1] || "";
  const start = text.match(/§(.+?)§/)?.[1] || "";
  const end = text.match(/@(.+?)@/)?.[1] || "";
  const color = text.match(/∮(.+?)∮/)?.[1] || "";

  const stationStr = text.split(/】/)[1] || "";
  const stations = stationStr.split("-").filter(x=>x && !x.includes("{"));

  return {text,name,company,region,type,start,end,color,stations};
}

function buildLine(l){
  let s = `【${l.name}】${l.stations.join("-")}-{${l.company}}`;
  if(l.region) s += `『${l.region}』`;
  if(l.type) s += `θ${l.type}θ`;
  if(l.start) s += `§${l.start}§`;
  if(l.end) s += `@${l.end}@`;
  if(l.color) s += `∮${l.color}∮`;
  return s;
}

async function login(){

  const password=document.getElementById("pwd").value;

  const res=await fetch(API,{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({mode:"login",password})
  });

  const data=await res.json();
  if(!data.success){alert("口令错误");return;}

  role=data.type;
  roleValue=data.value||"";

  document.getElementById("login").style.display="none";
  document.getElementById("main").style.display="block";

  load();
}

async function load(){
  const res=await fetch(API);
  rawText=await res.text();

  const arr = rawText.split(/[\n\r]+/).filter(x=>x.trim());
  lines=arr.map(parseLine);

  render();
}

function getVisible(){
  if(role==="super") return lines;
  if(role==="region") return lines.filter(x=>x.region===roleValue);
  if(role==="company") return lines.filter(x=>x.company===roleValue);
  return [];
}

function render(){

  document.getElementById("list").innerHTML="";

  getVisible().forEach((l,i)=>{
    const card=document.createElement("div");
    card.className="card";

    card.innerHTML=`
      <input value="${l.name}" onchange="l.name=this.value;save()">
      <input value="${l.company}" onchange="l.company=this.value;save()">
      <input value="${l.region}" onchange="l.region=this.value;save()">
      类型:
      <select onchange="l.type=this.value;save()">
        <option>${l.type}</option>
        <option>公交</option>
        <option>地铁</option>
        <option>铁路</option>
        <option>单轨</option>
      </select>
      首班车:<input type="time" value="${l.start}" onchange="l.start=this.value;save()">
      末班车:<input type="time" value="${l.end}" onchange="l.end=this.value;save()">
      <div id="st-${i}"></div>
      <button onclick="addStation(${i})">增加站点</button>
      <button class="delete" onclick="removeLine(${i})">删除线路</button>
    `;

    document.getElementById("list").appendChild(card);
    renderStations(i);
  });
}

function renderStations(i){
  const box=document.getElementById("st-"+i);
  box.innerHTML="";
  getVisible()[i].stations.forEach((s,j)=>{
    const div=document.createElement("div");
    div.className="station";
    div.innerHTML=`
      <input value="${s}" onchange="getVisible()[${i}].stations[${j}]=this.value;save()">
      <button class="delete" onclick="removeStation(${i},${j})">X</button>
    `;
    box.appendChild(div);
  });
}

function addLine(){
  lines.push({
    name:"新线路",
    company:"",
    region:"",
    type:"公交",
    start:"06:00",
    end:"22:00",
    color:"",
    stations:[]
  });
  render();
  save();
}

function addStation(i){
  getVisible()[i].stations.push("新站点");
  render();
  save();
}

function removeStation(i,j){
  getVisible()[i].stations.splice(j,1);
  render();
  save();
}

function removeLine(i){
  const v=getVisible();
  const real=lines.indexOf(v[i]);
  lines.splice(real,1);
  render();
  save();
}

async function save(){
  const text=lines.map(buildLine).join("\n");
  const res=await fetch(API,{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({mode:"save",content:text})
  });
  if(!res.ok) alert("保存失败！");
}

</script>

</body>
</html>

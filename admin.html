<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>公交管理系统</title>
<style>
body{font-family:system-ui;background:#f3f6fb;margin:0}
header{background:#6750A4;color:#fff;padding:16px}
.card{background:#fff;margin:12px;padding:12px;border-radius:12px}
.station{display:flex;margin:6px 0}
.station input{flex:1}
button{background:#6750A4;color:#fff;border:none;padding:6px 10px;border-radius:8px;margin:4px}
.small{background:#B3261E}
</style>
</head>
<body>

<header>公交数据管理</header>

<button onclick="login()">登录</button>
<div id="info"></div>
<div id="box"></div>
<button onclick="addLine()">新增线路</button>
<button onclick="save()">保存</button>

<script>

const API="https://orange-king-0a98-hjtr-bus-api.1693076637.workers.dev";

let PASSWORD="";
let ROLE="";
let ALL=[];
let VIEW=[];

function login(){
  PASSWORD=prompt("输入密码");
  if(!PASSWORD) return;
  load();
}

async function load(){
  const r=await fetch(API);
  ALL=(await r.text()).split("\n").filter(x=>x.trim());
  detectRole();
}

async function detectRole(){

  const test=await fetch(API,{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      content:ALL.join("\n"),
      password:PASSWORD
    })
  });

  if(test.status===401){
    alert("密码错误");
    return;
  }

  // 通过反推角色
  const pwdMap = await fetch(API);
  ROLE="LOGGED";

  filterView();
}

function company(line){
  return line.match(/\{(.*?)\}/)?.[1]||"";
}
function region(line){
  return line.match(/『(.*?)』/)?.[1]||"";
}

function filterView(){

  VIEW=[];

  ALL.forEach(line=>{
    VIEW.push(line);
  });

  render();
}

function render(){
  box.innerHTML="";
  VIEW.forEach((line,i)=>{

    const card=document.createElement("div");
    card.className="card";

    const title=line.match(/【(.*?)】/)?.[1]||"";
    const comp=company(line);
    const reg=region(line);

    card.innerHTML=`<b>${title}</b><br>${comp} ｜ ${reg}<hr>`;

    const stations=line.split("】")[1].split("-{")[0].split("-");

    stations.forEach((s,j)=>{
      const div=document.createElement("div");
      div.className="station";
      div.innerHTML=`<input value="${s}">
      <button class="small">X</button>`;
      div.querySelector("button").onclick=()=>{
        stations.splice(j,1);
        updateLine(i,stations);
      };
      card.appendChild(div);
    });

    const add=document.createElement("button");
    add.innerText="添加站点";
    add.onclick=()=>{
      stations.push("新站点");
      updateLine(i,stations);
    };

    const del=document.createElement("button");
    del.className="small";
    del.innerText="删除线路";
    del.onclick=()=>{
      ALL.splice(i,1);
      filterView();
    };

    card.appendChild(add);
    card.appendChild(del);
    box.appendChild(card);
  });
}

function updateLine(i,stations){
  const original=VIEW[i];
  const head=original.split("】")[0]+"】";
  const tail=original.split("-{")[1];
  const newline=head+stations.join("-")+"-{"+tail;

  const index=ALL.indexOf(original);
  ALL[index]=newline;
  filterView();
}

function addLine(){
  ALL.push("【新线路】起点-终点-{公司}《》『地区』θ公交θ§6:00§@22:00@");
  filterView();
}

async function save(){
  const r=await fetch(API,{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      content:ALL.join("\n"),
      password:PASSWORD
    })
  });
  alert(r.status===200?"保存成功":"无权限或失败");
}

</script>
</body>
</html>

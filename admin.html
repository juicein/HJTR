<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>线路编辑系统</title>
<style>
body{font-family:Arial;margin:0;background:#f5f5f5}
.topbar{
  background:#1976d2;
  color:white;
  padding:10px;
  display:flex;
  justify-content:space-between;
}
button{padding:6px 12px;margin-left:5px}
.card{
  background:white;
  margin:10px;
  padding:10px;
  border-radius:6px;
}
input,select{margin:4px;padding:4px}
</style>
</head>
<body>

<div class="topbar">
  <div>线路管理系统</div>
  <div>
    <button onclick="addLine()">新增线路</button>
    <button onclick="saveData()">保存</button>
  </div>
</div>

<div id="list"></div>

<script>

const API="https://你的workers域名.workers.dev";
let rawText="";
let lines=[];

function parseLine(str){

  return {
    raw:str,
    line: str.match(/【(.*?)】/)?.[1]||"",
    stations: str.match(/】(.*?)-\{/)?.[1]||"",
    company: str.match(/\{(.*?)\}/)?.[1]||"",
    note: str.match(/《(.*?)》/)?.[1]||"",
    area: str.match(/『(.*?)』/)?.[1]||"",
    type: str.match(/θ(.*?)θ/)?.[1]||"公交",
    first: str.match(/§(.*?)§/)?.[1]||"",
    last: str.match(/@(.*?)@/)?.[1]||"",
    color: str.match(/∮(.*?)∮/)?.[1]||"000000"
  };
}

function buildLine(obj){
  return `【${obj.line}】${obj.stations}-{${obj.company}}《${obj.note}》『${obj.area}』θ${obj.type}θ§${obj.first}§@${obj.last}@∮${obj.color}∮`;
}

async function load(){
  const r=await fetch(API);
  rawText=await r.text();
  lines=rawText.split("\n").filter(x=>x.trim()!="").map(parseLine);
  render();
}

function render(){
  const list=document.getElementById("list");
  list.innerHTML="";

  lines.forEach((l,i)=>{
    list.innerHTML+=`
    <div class="card">
      线路:<input value="${l.line}" onchange="lines[${i}].line=this.value"><br>
      站点:<input value="${l.stations}" onchange="lines[${i}].stations=this.value"><br>
      公司:<input value="${l.company}" onchange="lines[${i}].company=this.value"><br>
      地区:<input value="${l.area}" onchange="lines[${i}].area=this.value"><br>
      类型:
      <select onchange="lines[${i}].type=this.value">
        <option ${l.type=="公交"?"selected":""}>公交</option>
        <option ${l.type=="地铁"?"selected":""}>地铁</option>
        <option ${l.type=="单轨"?"selected":""}>单轨</option>
        <option ${l.type=="铁路"?"selected":""}>铁路</option>
      </select><br>
      首班:<input type="time" value="${l.first}" onchange="lines[${i}].first=this.value"><br>
      末班:<input type="time" value="${l.last}" onchange="lines[${i}].last=this.value"><br>
      票价说明:<input value="${l.note}" onchange="lines[${i}].note=this.value"><br>
      颜色:<input value="${l.color}" onchange="lines[${i}].color=this.value"><br>
      <button onclick="removeLine(${i})">删除</button>
    </div>
    `;
  });
}

function addLine(){
  lines.push({
    line:"",
    stations:"",
    company:"",
    note:"",
    area:"",
    type:"公交",
    first:"06:00",
    last:"22:00",
    color:"000000"
  });
  render();
}

function removeLine(i){
  lines.splice(i,1);
  render();
}

async function saveData(){

  const password=prompt("输入管理密码");
  if(!password)return;

  const content=lines.map(buildLine).join("\n");

  const r=await fetch(API,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({content,password})
  });

  alert(await r.text());
}

load();

</script>
</body>
</html>
</html>

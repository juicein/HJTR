<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>HJTR 公交管理系统</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{margin:0;font-family:system-ui;background:#eef3f8}
header{background:#003f6b;color:#fff;padding:16px;font-size:18px}
.container{max-width:1200px;margin:auto;padding:20px}
.card{
  background:#fff;
  padding:15px;
  border-radius:12px;
  margin-bottom:15px;
  box-shadow:0 3px 10px rgba(0,0,0,0.08)
}
input,select{
  width:100%;
  padding:6px;
  margin:4px 0;
}
button{
  padding:6px 12px;
  border:none;
  border-radius:8px;
  background:#006495;
  color:#fff;
  cursor:pointer;
  margin-right:6px;
}
#loginBox{
  max-width:400px;
  margin:100px auto;
  background:#fff;
  padding:20px;
  border-radius:12px;
}
.topbar{
  display:flex;
  justify-content:space-between;
  margin-bottom:15px;
}
</style>
</head>

<body>

<header>HJTR 公交数据管理</header>

<div id="loginBox">
  <h3>管理员登录</h3>
  <input id="username" placeholder="名称（公司名/地区名/admin）">
  <input id="password" type="password" placeholder="密码">
  <button onclick="login()">登录</button>
</div>

<div class="container" id="app" hidden>
  <div class="topbar">
    <div id="roleInfo"></div>
    <div>
      <button onclick="addLine()">新增</button>
      <button onclick="saveAll()">保存</button>
      <button onclick="logout()">退出</button>
    </div>
  </div>
  <div id="list"></div>
</div>

<script>

const API="https://orange-king-0a98-hjtr-bus-api.1693076637.workers.dev";

let role=null;
let allLines=[];
let visibleLines=[];

function login(){
  localStorage.setItem("auth_user",username.value);
  localStorage.setItem("auth_pass",password.value);
  init();
}

function logout(){
  localStorage.clear();
  location.reload();
}

async function init(){

  const user=localStorage.getItem("auth_user");
  const pass=localStorage.getItem("auth_pass");
  if(!user)return;

  const res=await fetch(API);
  const text=await res.text();

  allLines=text.split("\n").filter(x=>x.trim());

  const test=await fetch(API,{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({username:user,password:pass,content:text})
  });

  if(test.status===401){
    alert("权限错误");
    logout();
    return;
  }

  const data=await test.json();
  role=data.role;

  document.getElementById("loginBox").hidden=true;
  document.getElementById("app").hidden=false;

  roleInfo.innerText="身份："+role.type+"："+role.name;

  filterLines();
  render();
}

function filterLines(){

  if(role.type==="super"){
    visibleLines=[...allLines];
    return;
  }

  visibleLines=allLines.filter(x=>{
    if(role.type==="company")
      return x.includes(`{${role.name}}`);
    if(role.type==="region")
      return x.includes(`『${role.name}』`);
  });
}

function render(){

  list.innerHTML="";

  visibleLines.forEach((line,i)=>{

    const name=line.match(/【(.+?)】/)?.[1]||"";
    const company=line.match(/\{(.+?)\}/)?.[1]||"";
    const region=line.match(/『(.+?)』/)?.[1]||"";
    const type=line.match(/θ(.+?)θ/)?.[1]||"";

    const card=document.createElement("div");
    card.className="card";

    card.innerHTML=`
      <label>线路名</label>
      <input value="${name}" id="name${i}">
      <label>公司</label>
      <input value="${company}" id="company${i}">
      <label>地区</label>
      <input value="${region}" id="region${i}">
      <label>类型</label>
      <input value="${type}" id="type${i}">
      <br>
      <button onclick="updateLine(${i})">修改</button>
      <button onclick="deleteLine(${i})">删除</button>
    `;

    list.appendChild(card);
  });
}

function updateLine(i){

  const name=document.getElementById("name"+i).value;
  const company=document.getElementById("company"+i).value;
  const region=document.getElementById("region"+i).value;
  const type=document.getElementById("type"+i).value;

  visibleLines[i]=
  `【${name}】示例站点1-示例站点2-{${company}}《票价88元》『${region}』θ${type}θ§6:00§@22:30@`;

  rebuildAll();
  render();
}

function deleteLine(i){
  visibleLines.splice(i,1);
  rebuildAll();
  render();
}

function addLine(){

  const newline=
  `【新线路】起点-终点-{${role.type==="company"?role.name:"公司名"}}《票价888元》『${role.type==="region"?role.name:"地区名"}』θ公交θ§6:00§@22:30@`;

  visibleLines.push(newline);
  rebuildAll();
  render();
}

function rebuildAll(){

  if(role.type==="super"){
    allLines=[...visibleLines];
    return;
  }

  allLines=allLines.filter(x=>{
    if(role.type==="company")
      return !x.includes(`{${role.name}}`);
    if(role.type==="region")
      return !x.includes(`『${role.name}』`);
  });

  allLines=[...allLines,...visibleLines];
}

async function saveAll(){

  const user=localStorage.getItem("auth_user");
  const pass=localStorage.getItem("auth_pass");

  const res=await fetch(API,{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      username:user,
      password:pass,
      content:allLines.join("\n")
    })
  });

  if(res.ok) alert("保存成功");
  else alert("保存失败");
}

init();

</script>
</body>
</html>

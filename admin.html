<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>HJTR 管理后台</title>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  font-family:Roboto,sans-serif;
  background:#f4f6fb;
}
header{
  background:#6750A4;
  color:white;
  padding:20px;
  font-size:20px;
}
.container{
  padding:20px;
  max-width:900px;
  margin:auto;
}
.card{
  background:white;
  border-radius:16px;
  padding:20px;
  box-shadow:0 4px 10px rgba(0,0,0,0.1);
  margin-bottom:20px;
}
input, select, button{
  width:100%;
  padding:12px;
  margin-top:10px;
  border-radius:12px;
  border:1px solid #ccc;
  font-size:14px;
}
button{
  background:#6750A4;
  color:white;
  border:none;
  cursor:pointer;
}
.station-item{
  display:flex;
  gap:10px;
  margin-top:10px;
}
.station-item input{
  flex:1;
}
</style>
</head>

<body>

<header>HJTR 后台管理</header>

<div class="container">

<div class="card">
<h3>登录</h3>
<input type="password" id="password" placeholder="输入后台密码">
<button onclick="login()">登录</button>
</div>

<div class="card" id="editor" style="display:none;">
<h3>新增线路</h3>

<input id="lineName" placeholder="线路名称">

<select id="companySelect"></select>
<input id="companyManual" placeholder="或手动输入公司名称">

<div id="stations"></div>
<button onclick="addStation()">添加站点</button>

<button onclick="submitData()">提交到 GitHub</button>

</div>

</div>

<script>
const WORKER_URL="https://orange-king-0a98-hjtr-bus-api.1693076637.workers.dev/";

let logos={};

async function loadCompanies(){
  const res=await fetch("../data/logos_company.json");
  logos=await res.json();
  const select=document.getElementById("companySelect");
  select.innerHTML="";
  Object.keys(logos).forEach(name=>{
    const option=document.createElement("option");
    option.value=name;
    option.textContent=name;
    select.appendChild(option);
  });
}

function login(){
  const pwd=document.getElementById("password").value;
  if(!pwd){alert("请输入密码");return;}
  document.getElementById("editor").style.display="block";
}

function addStation(){
  const div=document.createElement("div");
  div.className="station-item";
  div.innerHTML=`<input placeholder="站点名称">`;
  document.getElementById("stations").appendChild(div);
}

async function submitData(){

  const password=document.getElementById("password").value;

  const lineName=document.getElementById("lineName").value;

  const companyManual=document.getElementById("companyManual").value;
  const companySelect=document.getElementById("companySelect").value;

  const company=companyManual||companySelect;

  const stations=[...document.querySelectorAll(".station-item input")]
      .map(i=>i.value)
      .filter(v=>v);

  const data={
    name:lineName,
    company:company,
    logo:logos[company]||"",
    stations:stations
  };

  const res=await fetch(WORKER_URL,{
    method:"POST",
    headers:{
      "Content-Type":"application/json"
    },
    body:JSON.stringify({
      password:password,
      data:data
    })
  });

  const result=await res.json();

  if(result.success){
    alert("提交成功！");
  }else{
    alert("错误："+JSON.stringify(result));
  }
}

loadCompanies();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>公交管理系统</title>

<style>
body{font-family:system-ui;background:#f6f6f6;padding:20px}
.card{
  background:#fff;
  padding:20px;
  border-radius:18px;
  margin-bottom:20px;
  box-shadow:0 6px 16px rgba(0,0,0,0.08);
}
input,select{
  width:100%;
  padding:8px;
  margin:6px 0;
  border-radius:8px;
  border:1px solid #ccc;
}
button{
  padding:8px 16px;
  border:none;
  border-radius:20px;
  background:#6750A4;
  color:white;
  cursor:pointer;
  margin:5px 5px 5px 0;
}
.delete{background:#B3261E}
.station{display:flex;gap:6px;margin-bottom:5px}
.station input{flex:1}
</style>
</head>
<body>

<h2>公交管理系统</h2>

<div id="login" class="card">
  <input id="pwd" placeholder="输入管理员口令">
  <button onclick="login()">登录</button>
</div>

<div id="main" style="display:none">
  <button onclick="addLine()">新增线路</button>
  <div id="list"></div>
</div>

<script>

const API="https://orange-king-0a98-hjtr-bus-api.1693076637.workers.dev";

let rawText="";
let lines=[];
let role="";
let roleValue="";

function parseLine(text){

  const name=text.match(/【(.*?)】/)[1];
  const company=text.match(/{(.*?)}/)[1];
  const region=text.match(/『(.*?)』/)[1];
  const type=text.match(/θ(.*?)θ/)[1];
  const start=text.match(/§(.*?)§/)[1];
  const end=text.match(/@(.*?)@/)[1];
  const color=text.match(/∮(.*?)∮/)[1];

  const stationPart=text.split("】")[1].split("-{")[0];
  const stations=stationPart.split("-").filter(s=>s);

  return {name,company,region,type,start,end,color,stations};
}

function buildLine(l){
  return `【${l.name}】${l.stations.join("-")}-{${l.company}}《》『${l.region}』θ${l.type}θ§${l.start}§@${l.end}@∮${l.color}∮`;
}

async function login(){

  const password=document.getElementById("pwd").value;

  const res=await fetch(API,{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({mode:"login",password})
  });

  const data=await res.json();
  if(!data.success){alert("口令错误");return;}

  role=data.type;
  roleValue=data.value||"";

  document.getElementById("login").style.display="none";
  document.getElementById("main").style.display="block";

  load();
}

async function load(){
  const res=await fetch(API);
  rawText=await res.text();

  const arr=rawText.split("\n").filter(x=>x.trim());
  lines=arr.map(parseLine);

  render();
}

function getVisible(){
  if(role==="super")return lines;
  if(role==="region")return lines.filter(x=>x.region===roleValue);
  if(role==="company")return lines.filter(x=>x.company===roleValue);
}

function render(){

  const container=document.getElementById("list");
  container.innerHTML="";

  getVisible().forEach((l,i)=>{

    const card=document.createElement("div");
    card.className="card";

    card.innerHTML=`
    <input value="${l.name}" onchange="l.name=this.value;save()">
    <input value="${l.company}" onchange="l.company=this.value;save()">
    <input value="${l.region}" onchange="l.region=this.value;save()">
    <input value="${l.type}" onchange="l.type=this.value;save()">
    首班车:<input type="time" value="${l.start}" onchange="l.start=this.value;save()">
    末班车:<input type="time" value="${l.end}" onchange="l.end=this.value;save()">
    <div id="st-${i}"></div>
    <button onclick="addStation(${i})">增加站点</button>
    <button class="delete" onclick="removeLine(${i})">删除线路</button>
    `;

    container.appendChild(card);
    renderStations(i);
  });
}

function renderStations(i){
  const box=document.getElementById("st-"+i);
  box.innerHTML="";
  getVisible()[i].stations.forEach((s,j)=>{
    const div=document.createElement("div");
    div.className="station";
    div.innerHTML=`
      <input value="${s}" onchange="getVisible()[${i}].stations[${j}]=this.value;save()">
      <button class="delete" onclick="removeStation(${i},${j})">X</button>
    `;
    box.appendChild(div);
  });
}

function addStation(i){
  getVisible()[i].stations.push("新站点");
  render();
  save();
}

function removeStation(i,j){
  getVisible()[i].stations.splice(j,1);
  render();
  save();
}

function removeLine(i){
  const realIndex=lines.indexOf(getVisible()[i]);
  lines.splice(realIndex,1);
  render();
  save();
}

function addLine(){
  lines.push({
    name:"新线路",
    company:role==="company"?roleValue:"",
    region:role==="region"?roleValue:"",
    type:"公交",
    start:"06:00",
    end:"22:00",
    color:"FFFFFF",
    stations:[]
  });
  render();
  save();
}

async function save(){

  const newText=lines.map(buildLine).join("\n");

  const res=await fetch(API,{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({mode:"save",content:newText})
  });

  if(!res.ok){
    alert("保存失败！");
  }
}

</script>
</body>
</html>

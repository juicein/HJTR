<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>å…¬äº¤æ•°æ® Wiki ç¼–è¾‘å™¨</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
:root { --p:#006495; }
body{
  margin:0;
  font-family:system-ui;
  background:#f4f7fb;
}
header{
  background:var(--p);
  color:#fff;
  padding:14px 18px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
main{
  max-width:1200px;
  margin:20px auto;
  padding:0 16px;
}
.tabs button{
  margin-right:8px;
  padding:6px 12px;
  border-radius:6px;
  border:none;
}
textarea{
  width:100%;
  height:65vh;
  padding:14px;
  border-radius:10px;
  border:1px solid #ccc;
  font-family:ui-monospace,monospace;
  white-space:pre;
}
#visual .card{
  background:#fff;
  padding:12px;
  border-radius:10px;
  margin-bottom:10px;
}
button{
  background:var(--p);
  color:#fff;
  border:none;
  padding:8px 14px;
  border-radius:8px;
}
#status{margin-top:8px;color:#666}
</style>
</head>

<body>
<header>
  ğŸšŒ å…¬äº¤ Wiki ç¼–è¾‘å™¨
  <button onclick="auth()">ç®¡ç†</button>
</header>

<main>
  <div class="tabs">
    <button onclick="setMode('text')">æ–‡æœ¬æ¨¡å¼</button>
    <button onclick="setMode('visual')">å¯è§†åŒ–æ¨¡å¼</button>
    <button onclick="addLine()">æ–°å¢</button>
  </div>

  <textarea id="editor"></textarea>
  <div id="visual" hidden></div>

  <button onclick="save()">ä¿å­˜</button>
  <div id="status"></div>
</main>

<script>
/* ================= é…ç½® ================= */
const API = "https://orange-king-0a98-hjtr-bus-api.1693076637.workers.dev";

/* ================= çŠ¶æ€ ================= */
let mode = "text";
const editor = document.getElementById("editor");
const visual = document.getElementById("visual");
const status = document.getElementById("status");

/* ================= è®¤è¯ ================= */
function auth(){
  const p = prompt("è¯·è¾“å…¥ç¼–è¾‘å£ä»¤");
  if(p) localStorage.setItem("wiki_pwd",p);
}
function pwd(){
  return localStorage.getItem("wiki_pwd");
}

/* ================= åŠ è½½ ================= */
window.onload = async ()=>{
  try{
    const res = await fetch(API);
    editor.value = await res.text();
  }catch(e){
    alert("æ— æ³•è¿æ¥ Worker");
  }
};

/* ================= æ¨¡å¼ ================= */
function setMode(m){
  mode = m;
  if(m==="visual"){
    editor.hidden=true;
    visual.hidden=false;
    renderVisual();
  }else{
    visual.hidden=true;
    editor.hidden=false;
  }
}

/* ================= ä¿å­˜ ================= */
async function save(){
  status.textContent="ä¿å­˜ä¸­...";
  const res = await fetch(API,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      content:editor.value,
      password:pwd()
    })
  });
  status.textContent = await res.text();
}

/* ================= è§£æ ================= */
function parseLines(txt){
  return txt
    .split("\n")
    .filter(x=>x.includes("ã€"));
}
function field(s,r){
  return s.match(r)?.[1]||"";
}

/* ================= å¯è§†åŒ– ================= */
function renderVisual(){
  visual.innerHTML="";
  let lines=parseLines(editor.value);

  lines.forEach((f,i)=>{
    const no = field(f,/ã€(.+?)ã€‘/);
    const com = field(f,/\{(.+?)\}/);

    const div=document.createElement("div");
    div.className="card";
    div.innerHTML=`
      <b>${no}</b> ï½œ ${com}<br>
      <button onclick="editLine(${i})">ä¿®æ”¹</button>
      <button onclick="deleteLine(${i})">åˆ é™¤</button>
    `;

    visual.appendChild(div);
  });
}

function editLine(i){
  let lines=parseLines(editor.value);
  const n=prompt("ä¿®æ”¹çº¿è·¯",lines[i]);
  if(n){
    lines[i]=n;
    editor.value=lines.join("\n");
    renderVisual();
  }
}

function deleteLine(i){
  let lines=parseLines(editor.value);
  lines.splice(i,1);
  editor.value=lines.join("\n");
  renderVisual();
}

function addLine(){
  let lines=parseLines(editor.value);
  const n=prompt("æ–°å¢çº¿è·¯ï¼ˆå®Œæ•´æ ¼å¼ï¼‰");
  if(n){
    lines.push(n);
    editor.value=lines.join("\n");
    renderVisual();
  }
}
</script>
</body>
</html>

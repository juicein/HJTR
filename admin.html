<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>公交数据 Wiki 编辑器</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
:root { --p:#006495; }
body{margin:0;font-family:system-ui;background:#f4f7fb}
header{background:var(--p);color:#fff;padding:14px 18px;display:flex;justify-content:space-between;align-items:center}
main{max-width:1200px;margin:20px auto;padding:0 16px}
textarea{width:100%;height:65vh;padding:14px;border-radius:10px;border:1px solid #ccc;font-family:ui-monospace,monospace;white-space:pre}
#visual .card{background:#fff;padding:12px;border-radius:10px;margin-bottom:10px}
button{background:var(--p);color:#fff;border:none;padding:8px 14px;border-radius:8px;margin-right:6px}
input{padding:6px;margin-right:6px}
#status{margin-top:8px;color:#666}
</style>
</head>

<body>

<header>
公交 Wiki 编辑器
</header>

<main>

<!-- 登录 -->
<div id="loginBox">
  <input id="username" placeholder="管理员名称">
  <input id="password" type="password" placeholder="密码">
  <button onclick="login()">登录</button>
  <div id="loginMsg"></div>
</div>

<!-- 主面板 -->
<div id="panel" hidden>

<div>
  <button onclick="setMode('text')">文本模式</button>
  <button onclick="setMode('visual')">可视化模式</button>
</div>

<textarea id="editor"></textarea>
<div id="visual" hidden></div>

<button onclick="save()">保存</button>
<div id="status"></div>

</div>

</main>

<script>
/* ================= 配置 ================= */
const API = "https://orange-king-0a98-hjtr-bus-api.1693076637.workers.dev/";
const RAW = "https://haojin.guanmu233.cn/data/bus_data.txt";

/* ================= 状态 ================= */
let mode="text";
let role=null;
let scope=null;

const editor=document.getElementById("editor");
const visual=document.getElementById("visual");
const status=document.getElementById("status");

/* ================= 登录 ================= */
async function login(){
  const u=username.value.trim();
  const p=password.value.trim();

  if(!u||!p){
    loginMsg.textContent="请输入账号密码";
    return;
  }

  // 用空内容测试权限
  const r=await fetch(API,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      content:"",
      username:u,
      password:p,
      test:true
    })
  });

  if(r.status===403){
    loginMsg.textContent="账号或密码错误";
    return;
  }

  role=(await r.text()); // Worker 返回角色

  scope=u;

  loginBox.hidden=true;
  panel.hidden=false;

  load();
}

/* ================= 加载原文件 ================= */
async function load(){
  const res=await fetch(RAW);
  editor.value=await res.text();
  renderVisual();
}

/* ================= 模式切换 ================= */
function setMode(m){
  mode=m;
  if(m==="visual"){
    editor.hidden=true;
    visual.hidden=false;
    renderVisual();
  }else{
    visual.hidden=true;
    editor.hidden=false;
  }
}

/* ================= 解析 ================= */
function parseLines(txt){
  return txt.split("\n").filter(x=>x.trim());
}

function getCompany(line){
  return line.match(/\{(.+?)\}/)?.[1]||"";
}

function getRegion(line){
  return line.match(/『(.+?)』/)?.[1]||"";
}

/* ================= 可视化 ================= */
function renderVisual(){
  visual.innerHTML="";
  let lines=parseLines(editor.value);

  lines.forEach((line,i)=>{

    const company=getCompany(line);
    const region=getRegion(line);

    // 权限过滤
    if(role==="company" && company!==scope) return;
    if(role==="region" && region!==scope) return;

    const div=document.createElement("div");
    div.className="card";
    div.innerHTML=`
      ${line}<br>
      <button onclick="editLine(${i})">修改</button>
      <button onclick="deleteLine(${i})">删除</button>
    `;
    visual.appendChild(div);
  });
}

function editLine(i){
  let lines=parseLines(editor.value);
  const newLine=prompt("修改线路",lines[i]);
  if(newLine){
    lines[i]=newLine;
    editor.value=lines.join("\n");
    renderVisual();
  }
}

function deleteLine(i){
  let lines=parseLines(editor.value);
  lines.splice(i,1);
  editor.value=lines.join("\n");
  renderVisual();
}

/* ================= 保存 ================= */
async function save(){
  status.textContent="保存中...";

  const r=await fetch(API,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      content:editor.value,
      username:username.value,
      password:password.value
    })
  });

  status.textContent=await r.text();
}
</script>
</body>
</html>

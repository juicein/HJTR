<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>HJTR 公交管理后台</title>

<style>
:root{
  --p:#006495;
}
body{
  margin:0;
  font-family:system-ui;
  background:#f4f7fb;
}
header{
  background:var(--p);
  color:#fff;
  padding:16px;
  text-align:center;
  font-size:20px;
}
.container{
  max-width:1100px;
  margin:auto;
  padding:16px;
}
.card{
  background:#fff;
  border-radius:12px;
  padding:14px;
  margin-bottom:12px;
  box-shadow:0 4px 12px rgba(0,0,0,.05);
}
button{
  background:var(--p);
  color:#fff;
  border:none;
  padding:6px 12px;
  border-radius:8px;
  cursor:pointer;
}
input{
  padding:8px;
  width:100%;
  margin-bottom:8px;
  border-radius:8px;
  border:1px solid #ccc;
}
.flex{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}
.hidden{display:none;}
@media(max-width:600px){
  .flex{flex-direction:column;}
}
</style>
</head>
<body>

<header>HJTR 公交管理系统</header>

<div class="container">

<div id="loginBox" class="card">
  <h3>管理员登录</h3>
  <input id="user" placeholder="用户名">
  <input id="pwd" type="password" placeholder="密码">
  <button onclick="login()">登录</button>
  <div id="loginMsg"></div>
</div>

<div id="adminPanel" class="hidden">

  <div class="card">
    <button onclick="addLine()">新增线路</button>
    <button onclick="save()">保存所有修改</button>
    <div id="status"></div>
  </div>

  <div id="list"></div>

</div>

</div>

<script>

const API="https://orange-king-0a98-hjtr-bus-api.1693076637.workers.dev/";

let rawData="";
let lines=[];
let currentUser=null;
let userInfo=null;

function parseLines(txt){
  return txt.split("\n").filter(x=>x.trim()!=="");
}

function getField(s,r){
  return s.match(r)?.[1]||"";
}

function login(){
  fetch(API,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      username:user.value,
      password:pwd.value,
      action:"login"
    })
  }).then(async r=>{
    if(!r.ok){
      loginMsg.innerText=await r.text();
      return;
    }
    userInfo=await r.json();
    currentUser=user.value;
    loginBox.classList.add("hidden");
    adminPanel.classList.remove("hidden");
    load();
  });
}

async function load(){
  const res=await fetch(API);
  rawData=await res.text();
  lines=parseLines(rawData);
  render();
}

function filterPermission(arr){
  if(userInfo.type==="super") return arr;

  if(userInfo.type==="region"){
    return arr.filter(x=>x.includes("『"+currentUser+"』"));
  }

  if(userInfo.type==="company"){
    return arr.filter(x=>x.includes("{"+currentUser+"}"));
  }
}

function render(){
  list.innerHTML="";
  const view=filterPermission(lines);

  view.forEach((l,i)=>{

    const name=getField(l,/【(.+?)】/);
    const company=getField(l,/\{(.+?)\}/);
    const region=getField(l,/『(.+?)』/);
    const type=getField(l,/θ(.+?)θ/);

    const div=document.createElement("div");
    div.className="card";
    div.innerHTML=`
      <b>${name}</b><br>
      公司: ${company} ｜ 地区: ${region} ｜ 类型: ${type}
      <div class="flex">
        <button onclick="editLine('${l.replace(/'/g,"")}')">修改</button>
        <button onclick="deleteLine('${l.replace(/'/g,"")}')">删除</button>
      </div>
    `;
    list.appendChild(div);
  });
}

function deleteLine(line){
  lines=lines.filter(x=>x!==line);
  render();
}

function editLine(line){
  const newLine=prompt("编辑整条线路数据：",line);
  if(newLine){
    const i=lines.indexOf(line);
    lines[i]=newLine;
    render();
  }
}

function addLine(){
  const newLine=prompt("输入完整线路字符串：");
  if(newLine){
    lines.push(newLine);
    render();
  }
}

function save(){
  fetch(API,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      username:currentUser,
      password:pwd.value,
      content:lines.join("\n"),
      action:"save"
    })
  }).then(async r=>{
    status.innerText=await r.text();
  });
}

</script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>HJTR 公交管理系统</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
<style>
body{
  margin:0;
  font-family:Roboto;
  background:#f4efff;
}
.header{
  background:#6750A4;
  color:white;
  padding:16px;
  font-size:20px;
}
.card{
  background:white;
  margin:16px;
  padding:16px;
  border-radius:20px;
  box-shadow:0 2px 10px rgba(0,0,0,0.08);
}
button{
  background:#6750A4;
  color:white;
  border:none;
  padding:8px 16px;
  border-radius:20px;
  cursor:pointer;
}
input,select,textarea{
  width:100%;
  padding:8px;
  margin:6px 0;
  border-radius:12px;
  border:1px solid #ccc;
}
.lineCard{
  border:1px solid #eee;
  border-radius:16px;
  padding:12px;
  margin-top:12px;
}
.logo{
  width:32px;
  vertical-align:middle;
  margin-right:8px;
}
</style>
</head>
<body>

<div class="header">HJTR 公交管理系统</div>

<div class="card">
<h3>登录</h3>

<select id="companySelect"></select>
<input id="companyInput" placeholder="或手动输入公司名">
<input id="password" type="password" placeholder="密码">
<button onclick="login()">登录</button>
</div>

<div id="panel" style="display:none"></div>

<script>

const WORKER_URL="orange-king-0a98-hjtr-bus-api.1693076637.workers.dev";

let currentCompany="";
let passwordValue="";
let rawText="";
let lines=[];
let logos={};

async function loadCompanies(){
  const res=await fetch("../data/logos_company.json");
  logos=await res.json();

  const select=document.getElementById("companySelect");
  select.innerHTML="<option value=''>选择公司</option>";

  Object.keys(logos).forEach(name=>{
    select.innerHTML+=`<option value="${name}">${name}</option>`;
  });
}

loadCompanies();

async function login(){
  const selected=companySelect.value;
  const manual=companyInput.value.trim();

  currentCompany=manual||selected;
  passwordValue=password.value;

  const res=await fetch(WORKER_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      action:"getData",
      company:currentCompany,
      password:passwordValue
    })
  });

  if(res.status!==200){
    alert("认证失败");
    return;
  }

  const data=await res.json();
  rawText=data.text;
  parseData();
  render();
}

function parseData(){
  lines=rawText.split("\n").filter(l=>{
    return l.includes(`{${currentCompany}}`);
  });
}

function render(){
  panel.style.display="block";
  panel.innerHTML="";

  lines.forEach((line,i)=>{
    panel.innerHTML+=`
      <div class="card lineCard">
      <b>${line.match(/【(.*?)】/)?.[1]}</b>
      <textarea onchange="updateLine(${i},this.value)">${line}</textarea>
      <button onclick="deleteLine(${i})">删除</button>
      </div>
    `;
  });

  panel.innerHTML+=`<button onclick="save()">保存全部</button>`;
}

function updateLine(i,val){
  lines[i]=val;
}

function deleteLine(i){
  lines.splice(i,1);
  render();
}

async function save(){

  const other=rawText.split("\n").filter(l=>{
    return !l.includes(`{${currentCompany}}`);
  });

  const finalText=[...other,...lines].join("\n");

  await fetch(WORKER_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      action:"save",
      company:currentCompany,
      password:passwordValue,
      content:finalText
    })
  });

  alert("保存成功！");
}

</script>
</body>
</html>

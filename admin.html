<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>公交数据 Wiki 编辑器</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
:root { --p:#006495; }
body{margin:0;font-family:system-ui;background:#f4f7fb}
header{background:var(--p);color:#fff;padding:14px 18px;display:flex;justify-content:space-between;align-items:center}
main{max-width:1200px;margin:20px auto;padding:0 16px}
.tabs button{margin-right:8px;padding:6px 12px;border-radius:6px;border:none}
textarea{width:100%;height:65vh;padding:14px;border-radius:10px;border:1px solid #ccc;font-family:monospace;white-space:pre}
#visual .card{background:#fff;padding:12px;border-radius:10px;margin-bottom:10px}
button{background:var(--p);color:#fff;border:none;padding:8px 14px;border-radius:8px}
#status{margin-top:8px;color:#666}
</style>
</head>

<body>
<header>
  公交 Wiki 编辑器
  <button onclick="auth()">管理</button>
</header>

<main>

  <div class="tabs">
    <button onclick="setMode('text')">文本模式</button>
    <button onclick="setMode('visual')">可视化模式</button>
    <button onclick="addLine()">新增</button>
  </div>

  <textarea id="editor"></textarea>
  <div id="visual" hidden></div>

  <button onclick="save()">保存</button>
  <div id="status"></div>

</main>

<script>
const API="https://orange-king-0a98-hjtr-bus-api.1693076637.workers.dev/";

let mode="text";
let lines=[];

const editor=document.getElementById("editor");
const visual=document.getElementById("visual");
const status=document.getElementById("status");

/* 管理口令 */
function auth(){
  const p = prompt("请输入编辑口令");
  if(p) localStorage.setItem("wiki_pwd",p);
}
function pwd(){
  return localStorage.getItem("wiki_pwd");
}

/* 加载 */
window.onload = async ()=>{
  try{
    const r = await fetch(API);
    const txt = await r.text();
    editor.value = txt;
    parseToArray(txt);
  }catch(e){
    alert("无法连接 Worker");
  }
};

/* 解析为数组 */
function parseToArray(txt){
  lines = txt.split("\n").filter(x=>x.trim()!=="");
}

/* 同步文本 */
function syncText(){
  editor.value = lines.join("\n");
}

/* 模式切换 */
function setMode(m){
  mode=m;
  if(m==="visual"){
    editor.hidden=true;
    visual.hidden=false;
    parseToArray(editor.value);
    renderVisual();
  }else{
    visual.hidden=true;
    editor.hidden=false;
  }
}

/* 可视化渲染 */
function renderVisual(){
  visual.innerHTML="";
  lines.forEach((line,i)=>{
    const div=document.createElement("div");
    div.className="card";
    div.innerHTML=`
      ${line}<br>
      <button onclick="editLine(${i})">修改</button>
      <button onclick="deleteLine(${i})">删除</button>
    `;
    visual.appendChild(div);
  });
}

/* 修改 */
function editLine(i){
  const n = prompt("修改线路", lines[i]);
  if(n){
    lines[i]=n;
    syncText();
    renderVisual();
  }
}

/* 删除 */
function deleteLine(i){
  lines.splice(i,1);
  syncText();
  renderVisual();
}

/* 新增 */
function addLine(){
  const n = prompt("新增线路（完整格式）");
  if(n){
    lines.push(n);
    syncText();
    renderVisual();
  }
}

/* 保存 */
async function save(){
  status.textContent="保存中...";
  const r=await fetch(API,{
    method:"POST",
    headers:{ "Content-Type":"application/json"},
    body:JSON.stringify({
      content:editor.value,
      password:pwd()
    })
  });
  status.textContent=await r.text();
}
</script>
</body>
</html>

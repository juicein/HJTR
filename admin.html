<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>公交数据管理系统</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
:root{ --p:#006495; }
body{ margin:0;font-family:system-ui;background:#f4f7fb; }
header{
  background:var(--p);
  color:#fff;
  padding:14px 18px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
main{ max-width:1000px;margin:20px auto;padding:0 16px; }
.card{
  background:#fff;padding:14px;border-radius:10px;
  margin-bottom:12px;box-shadow:0 2px 6px rgba(0,0,0,.05);
}
button{
  background:var(--p);color:#fff;border:none;
  padding:8px 14px;border-radius:8px;margin-right:6px;
}
input{
  width:100%;padding:10px;margin-bottom:10px;
  border-radius:8px;border:1px solid #ccc;
}
textarea{
  width:100%;height:60vh;padding:14px;
  border-radius:10px;border:1px solid #ccc;
  font-family:monospace;
}
#status{margin-top:10px;color:#666}
</style>
</head>
<body>

<header>
  公交数据管理系统
  <div id="who"></div>
</header>

<main>

<div id="loginBox">
  <h3>管理员登录</h3>
  <input id="login_name" placeholder="名称">
  <input id="login_pwd" type="password" placeholder="密码">
  <button id="loginBtn">登录</button>
  <div id="loginMsg"></div>
</div>

<div id="panel" hidden>
  <button id="addBtn">新增线路</button>
  <button id="saveBtn">保存修改</button>
  <textarea id="editor"></textarea>
  <div id="visual"></div>
  <div id="status"></div>
</div>

</main>

<script>

const API="https://orange-king-0a98-hjtr-bus-api.1693076637.workers.dev";

let role=null;
let roleName=null;
let rawData="";

const loginBtn=document.getElementById("loginBtn");
const loginMsg=document.getElementById("loginMsg");
const loginBox=document.getElementById("loginBox");
const panel=document.getElementById("panel");
const who=document.getElementById("who");
const editor=document.getElementById("editor");
const visual=document.getElementById("visual");
const status=document.getElementById("status");

function parseLines(txt){
  return txt.split("\n").filter(x=>x.includes("【"));
}
function getCompany(s){ return s.match(/\{(.+?)\}/)?.[1]||""; }
function getRegion(s){ return s.match(/『(.+?)』/)?.[1]||""; }
function getName(s){ return s.match(/【(.+?)】/)?.[1]||""; }

loginBtn.onclick=async function(){

  loginMsg.innerText="";

  const n=document.getElementById("login_name").value.trim();
  const p=document.getElementById("login_pwd").value.trim();

  if(!n || !p){
    loginMsg.innerText="名称或密码不能为空";
    return;
  }

  try{
    const res=await fetch(API,{
      method:"POST",
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        action:"login",
        name:n,
        password:p
      })
    });

    if(!res.ok){
      loginMsg.innerText="服务器连接失败："+res.status;
      return;
    }

    const r=await res.json();

    if(!r.ok){
      loginMsg.innerText=r.msg;   // 会显示具体错误
      return;
    }

    role=r.role;
    roleName=r.name;

    who.innerText="当前身份："+role+" / "+roleName;

    loginBox.hidden=true;
    panel.hidden=false;

    await load();

  }catch(e){
    loginMsg.innerText="无法连接API："+e.message;
  }
};

async function load(){
  const res=await fetch(API);
  rawData=await res.text();
  filterRender();
}

function filterRender(){
  let lines=parseLines(rawData);

  if(role==="company"){
    lines=lines.filter(x=>getCompany(x)===roleName);
  }

  if(role==="region"){
    lines=lines.filter(x=>getRegion(x)===roleName);
  }

  editor.value=lines.join("\n");
  renderVisual();
}

function renderVisual(){
  visual.innerHTML="";
  parseLines(editor.value).forEach((l,i)=>{
    const div=document.createElement("div");
    div.className="card";
    div.innerHTML=`
      <b>${getName(l)}</b><br>
      公司：${getCompany(l)} ｜ 地区：${getRegion(l)}<br>
      <button onclick="del(${i})">删除</button>
    `;
    visual.appendChild(div);
  });
}

function del(i){
  let arr=parseLines(editor.value);
  arr.splice(i,1);
  editor.value=arr.join("\n");
  renderVisual();
}

document.getElementById("addBtn").onclick=function(){
  editor.value+="\n【新线路】站点1-站点2-{公司}《票价1元》『地区』θ公交θ§6:00§@22:00@∮FFFFFF∮";
  renderVisual();
};

document.getElementById("saveBtn").onclick=async function(){
  status.innerText="保存中...";
  try{
    const res=await fetch(API,{
      method:"POST",
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        action:"save",
        content:editor.value,
        role,
        roleName
      })
    });
    const r=await res.json();
    status.innerText=r.msg;
  }catch(e){
    status.innerText="保存失败："+e.message;
  }
};

</script>
</body>
</html>

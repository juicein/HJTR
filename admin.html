export default {
  async fetch(request, env) {

    const GITHUB_TOKEN = env.GITHUB_TOKEN;
    const OWNER = "juicein";
    const REPO = "HJTR";
    const FILE_PATH = "data/bus_data.txt";

    if (request.method === "GET") {
      const r = await fetch(
        `https://raw.githubusercontent.com/${OWNER}/${REPO}/main/${FILE_PATH}`
      );
      return new Response(await r.text(), {
        headers: { "Content-Type": "text/plain;charset=UTF-8" }
      });
    }

    if (request.method === "POST") {

      const body = await request.json();
      const { content, username, password } = body;

      const authText = await env.PASSWORDS.get("auth");
      const auth = JSON.parse(authText);

      let role = null;
      let scope = null;

      // 超级管理员
      if (auth.super[username] === password) {
        role = "super";
      }

      // 地区管理员
      if (!role && auth.region[username] === password) {
        role = "region";
        scope = username;
      }

      // 公司管理员
      if (!role && auth.company[username] === password) {
        role = "company";
        scope = username;
      }

      if (!role) {
        return new Response("账号或密码错误", { status: 403 });
      }

      // 获取原文件 sha
      const fileRes = await fetch(
        `https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}`,
        {
          headers: {
            Authorization: `Bearer ${GITHUB_TOKEN}`,
            Accept: "application/vnd.github+json"
          }
        }
      );

      const fileData = await fileRes.json();

      // 更新文件
      const updateRes = await fetch(
        `https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}`,
        {
          method: "PUT",
          headers: {
            Authorization: `Bearer ${GITHUB_TOKEN}`,
            Accept: "application/vnd.github+json"
          },
          body: JSON.stringify({
            message: "admin update bus_data",
            content: btoa(unescape(encodeURIComponent(content))),
            sha: fileData.sha
          })
        }
      );

      if (!updateRes.ok) {
        return new Response("GitHub 更新失败", { status: 500 });
      }

      return new Response("保存成功");
    }

    return new Response("Method Not Allowed", { status: 405 });
  }
};

<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>公交管理员</title>

<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">

<style>
body{
  margin:0;
  font-family:system-ui;
  background:#f5f5f5;
}

header{
  background:#6750A4;
  color:#fff;
  padding:16px;
  font-size:20px;
}

.container{
  padding:16px;
}

.card{
  background:#fff;
  border-radius:16px;
  padding:16px;
  margin-bottom:16px;
  box-shadow:0 2px 8px rgba(0,0,0,0.1);
}

input,select{
  width:100%;
  padding:10px;
  border-radius:12px;
  border:1px solid #ddd;
  margin-top:6px;
  margin-bottom:12px;
  font-size:14px;
}

button{
  background:#6750A4;
  color:white;
  border:none;
  padding:8px 16px;
  border-radius:20px;
  cursor:pointer;
  margin:4px 0;
}

button.delete{
  background:#B3261E;
}

.station-row{
  display:flex;
  gap:6px;
  margin-bottom:6px;
}

.station-row input{
  flex:1;
}
</style>
</head>
<body>

<header>公交管理员后台</header>

<div class="container">

<div id="loginCard" class="card">
<input id="password" placeholder="输入管理员口令">
<button onclick="login()">进入</button>
</div>

<div id="main" style="display:none">
<button onclick="addLine()">新增线路</button>
<div id="list"></div>
</div>

</div>

<script>

const API="https://orange-king-0a98-hjtr-bus-api.1693076637.workers.dev";

let allData=[];
let filteredData=[];
let adminType="";
let adminValue="";
let saveTimer=null;

function autoSave(){
  if(saveTimer) clearTimeout(saveTimer);
  saveTimer=setTimeout(save,2000);
}

async function login(){

  const pwd=document.getElementById("password").value;

  const res=await fetch(API,{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({mode:"verify",password:pwd})
  });

  const data=await res.json();

  if(!data.success){
    alert("口令错误");
    return;
  }

  adminType=data.type;
  adminValue=data.value||"";

  localStorage.setItem("adminType",adminType);
  localStorage.setItem("adminValue",adminValue);

  document.getElementById("loginCard").style.display="none";
  document.getElementById("main").style.display="block";

  loadData();
}

async function loadData(){
  const res=await fetch(API);
  const text=await res.text();
  allData=JSON.parse(text);
  applyFilter();
}

function applyFilter(){

  if(adminType==="super"){
    filteredData=allData;
  }
  else if(adminType==="area"){
    filteredData=allData.filter(x=>x.area===adminValue);
  }
  else if(adminType==="company"){
    filteredData=allData.filter(x=>x.company===adminValue);
  }

  render();
}

function render(){

  const box=document.getElementById("list");
  box.innerHTML="";

  filteredData.forEach((line,index)=>{

    const realIndex=allData.indexOf(line);

    const card=document.createElement("div");
    card.className="card";

    card.innerHTML=`
    <input value="${line.name}" onchange="update(${realIndex},'name',this.value)">
    <input value="${line.area}" onchange="update(${realIndex},'area',this.value)">
    <input value="${line.company}" onchange="update(${realIndex},'company',this.value)">
    首班车
    <input type="time" value="${line.start}" onchange="update(${realIndex},'start',this.value)">
    末班车
    <input type="time" value="${line.end}" onchange="update(${realIndex},'end',this.value)">
    <div id="stations-${realIndex}"></div>
    <button onclick="addStation(${realIndex})">增加站点</button>
    <button class="delete" onclick="removeLine(${realIndex})">删除线路</button>
    `;

    box.appendChild(card);
    renderStations(realIndex);
  });
}

function renderStations(i){
  const box=document.getElementById("stations-"+i);
  box.innerHTML="";
  allData[i].stations.forEach((st,j)=>{
    const row=document.createElement("div");
    row.className="station-row";
    row.innerHTML=`
      <input value="${st}" onchange="updateStation(${i},${j},this.value)">
      <button class="delete" onclick="removeStation(${i},${j})">X</button>
    `;
    box.appendChild(row);
  });
}

function update(i,key,val){
  allData[i][key]=val;
  autoSave();
}

function updateStation(i,j,val){
  allData[i].stations[j]=val;
  autoSave();
}

function addLine(){
  const newLine={
    name:"新线路",
    area:adminType==="area"?adminValue:"",
    company:adminType==="company"?adminValue:"",
    start:"06:00",
    end:"22:00",
    stations:[]
  };
  allData.push(newLine);
  applyFilter();
  autoSave();
}

function removeLine(i){
  allData.splice(i,1);
  applyFilter();
  autoSave();
}

function addStation(i){
  allData[i].stations.push("新站点");
  renderStations(i);
  autoSave();
}

function removeStation(i,j){
  allData[i].stations.splice(j,1);
  renderStations(i);
  autoSave();
}

async function save(){

  const pwd=document.getElementById("password").value;

  const res=await fetch(API,{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      mode:"save",
      password:pwd,
      content:JSON.stringify(allData,null,2)
    })
  });

  if(!res.ok){
    alert("保存失败");
  }
}

</script>
</body>
</html>

 <!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>公交数据管理</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{--p:#6750A4;}
body{margin:0;font-family:system-ui;background:#f4f7fb;}
header{background:var(--p);color:#fff;padding:16px;font-size:20px;}
main{max-width:1200px;margin:20px auto;padding:0 16px;}
.card{
  background:#fff;
  padding:16px;
  border-radius:14px;
  margin-bottom:14px;
  box-shadow:0 2px 8px rgba(0,0,0,.08);
}
.station{display:flex;gap:6px;margin-bottom:6px;}
input{padding:6px;border-radius:6px;border:1px solid #ccc;}
button{
  background:var(--p);
  color:#fff;
  border:none;
  padding:6px 12px;
  border-radius:6px;
  cursor:pointer;
}
.red{background:#B3261E;}
</style>
</head>

<body>

<header>公交数据管理系统</header>

<main>

<button onclick="login()">登录</button>
<button onclick="addLine()">新增线路</button>
<button onclick="save()">保存全部</button>
<div id="status"></div>
<hr>

<div id="container"></div>

</main>

<script>

const API="https://orange-king-0a98-hjtr-bus-api.1693076637.workers.dev";

let PASSWORD="";
let ROLE="";
let ALL=[];
let ORIGINAL="";

function login(){
  const p=prompt("输入密码");
  if(!p) return;
  PASSWORD=p;
  load();
}

async function load(){
  const res=await fetch(API);
  ORIGINAL=await res.text();
  ALL=ORIGINAL.split("\n").filter(x=>x.trim());
  render();
}

function getCompany(l){return l.match(/\{(.*?)\}/)?.[1]||"";}
function getRegion(l){return l.match(/『(.*?)』/)?.[1]||"";}

function render(){
  container.innerHTML="";

  ALL.forEach((line,i)=>{

    const card=document.createElement("div");
    card.className="card";

    const title=line.match(/【(.*?)】/)?.[1]||"";
    const company=getCompany(line);
    const region=getRegion(line);

    card.innerHTML=`<b>${title}</b><br>
    公司: ${company} ｜ 地区: ${region}<hr>`;

    const stations=line.split("】")[1].split("-{")[0].split("-");

    stations.forEach((s,j)=>{
      const row=document.createElement("div");
      row.className="station";
      row.innerHTML=`
        <input value="${s}">
        <button class="red">X</button>
      `;
      row.querySelector("button").onclick=()=>{
        stations.splice(j,1);
        updateLine(i,stations);
      };
      card.appendChild(row);
    });

    const add=document.createElement("button");
    add.innerText="添加站点";
    add.onclick=()=>{
      stations.push("新站点");
      updateLine(i,stations);
    };

    const del=document.createElement("button");
    del.className="red";
    del.innerText="删除线路";
    del.onclick=()=>{
      ALL.splice(i,1);
      render();
    };

    card.appendChild(add);
    card.appendChild(del);

    container.appendChild(card);
  });
}

function updateLine(i,stations){
  const orig=ALL[i];
  const head=orig.split("】")[0]+"】";
  const tail=orig.split("-{")[1];
  ALL[i]=head+stations.join("-")+"-{"+tail;
  render();
}

function addLine(){
  const newLine="【新线路】起点-终点-{公司名}《》『地区』§6:00§@22:00@";
  ALL.push(newLine);
  render();
}

async function save(){
  status.innerText="保存中...";
  const res=await fetch(API,{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      content:ALL.join("\n"),
      password:PASSWORD
    })
  });

  status.innerText=res.status===200?"保存成功":"密码错误";
}

</script>
</body>
</html>

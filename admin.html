<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>公交管理系统</title>

<style>
body{
  font-family:system-ui;
  background:#f5f5f5;
  margin:0;
  padding:20px;
}
h2{font-weight:500}
.card{
  background:white;
  border-radius:16px;
  padding:20px;
  margin-bottom:20px;
  box-shadow:0 4px 12px rgba(0,0,0,0.08);
}
input,select{
  width:100%;
  padding:10px;
  margin:6px 0;
  border-radius:8px;
  border:1px solid #ccc;
}
button{
  padding:8px 14px;
  border:none;
  border-radius:20px;
  cursor:pointer;
  background:#6750A4;
  color:white;
  margin:5px 5px 5px 0;
}
button.delete{
  background:#B3261E;
}
.station{
  display:flex;
  gap:8px;
  margin-bottom:6px;
}
.station input{flex:1}
</style>
</head>
<body>

<h2>公交管理系统</h2>

<div id="login" class="card">
  <input id="pwd" placeholder="输入管理员口令">
  <button onclick="login()">登录</button>
</div>

<div id="main" style="display:none">
  <button onclick="addLine()">新增线路</button>
  <div id="list"></div>
</div>

<script>

const API="https://orange-king-0a98-hjtr-bus-api.1693076637.workers.dev";

let allData=[];
let role="";
let roleValue="";

async function login(){

  const password=document.getElementById("pwd").value;

  const res=await fetch(API,{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({mode:"login",password})
  });

  const data=await res.json();

  if(!data.success){
    alert("口令错误");
    return;
  }

  role=data.type;
  roleValue=data.value || "";

  localStorage.setItem("role",role);
  localStorage.setItem("roleValue",roleValue);

  document.getElementById("login").style.display="none";
  document.getElementById("main").style.display="block";

  loadData();
}

async function loadData(){
  const res=await fetch(API);
  allData=JSON.parse(await res.text());
  render();
}

function getVisibleData(){
  if(role==="super") return allData;
  if(role==="region") return allData.filter(x=>x.region===roleValue);
  if(role==="company") return allData.filter(x=>x.company===roleValue);
}

function render(){

  const container=document.getElementById("list");
  container.innerHTML="";

  getVisibleData().forEach((line,index)=>{

    const card=document.createElement("div");
    card.className="card";

    card.innerHTML=`
    <input value="${line.name}" onchange="update(index,'name',this.value)">
    <input value="${line.region}" onchange="update(index,'region',this.value)">
    <input value="${line.company}" onchange="update(index,'company',this.value)">
    首班车:
    <input type="time" value="${line.start}" onchange="update(index,'start',this.value)">
    末班车:
    <input type="time" value="${line.end}" onchange="update(index,'end',this.value)">
    <div id="st-${index}"></div>
    <button onclick="addStation(index)">增加站点</button>
    <button class="delete" onclick="removeLine(index)">删除线路</button>
    `;

    container.appendChild(card);

    renderStations(index);
  });
}

function renderStations(i){
  const box=document.getElementById("st-"+i);
  box.innerHTML="";
  getVisibleData()[i].stations.forEach((s,j)=>{
    const div=document.createElement("div");
    div.className="station";
    div.innerHTML=`
      <input value="${s}" onchange="updateStation(${i},${j},this.value)">
      <button class="delete" onclick="removeStation(${i},${j})">X</button>
    `;
    box.appendChild(div);
  });
}

function update(i,key,value){
  const line=getVisibleData()[i];
  line[key]=value;
  autoSave();
}

function updateStation(i,j,value){
  getVisibleData()[i].stations[j]=value;
  autoSave();
}

function addStation(i){
  getVisibleData()[i].stations.push("新站点");
  render();
  autoSave();
}

function removeStation(i,j){
  getVisibleData()[i].stations.splice(j,1);
  render();
  autoSave();
}

function removeLine(i){
  const visible=getVisibleData();
  const realIndex=allData.indexOf(visible[i]);
  allData.splice(realIndex,1);
  render();
  autoSave();
}

function addLine(){
  allData.push({
    name:"新线路",
    region: role==="region"?roleValue:"",
    company: role==="company"?roleValue:"",
    start:"06:00",
    end:"22:00",
    stations:[]
  });
  render();
  autoSave();
}

async function autoSave(){
  const res=await fetch(API,{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      mode:"save",
      content:JSON.stringify(allData,null,2)
    })
  });

  if(!res.ok){
    alert("自动保存失败！");
  }
}

</script>
</body>
</html>

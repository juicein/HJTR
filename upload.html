<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>航班数据可视化编辑器</title>

<style>
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
  background: #f5f7fb;
}
header {
  padding: 16px;
  background: #006495;
  color: white;
  font-size: 20px;
}
.toolbar {
  display: flex;
  gap: 8px;
  padding: 12px;
}
button {
  padding: 8px 14px;
  border: none;
  border-radius: 8px;
  background: #006495;
  color: white;
  cursor: pointer;
}
button.secondary {
  background: #ddd;
  color: #333;
}
select, input {
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #ccc;
}
#list {
  padding: 12px;
}
.card {
  background: white;
  border-radius: 14px;
  padding: 14px;
  margin-bottom: 12px;
  box-shadow: 0 4px 10px rgba(0,0,0,.06);
}
.card h3 {
  margin: 0 0 6px;
}
.card small {
  color: #666;
}
.card-actions {
  margin-top: 10px;
}
.card-actions button {
  margin-right: 6px;
}
#editor {
  width: 100%;
  height: 70vh;
  font-family: monospace;
}
.hidden {
  display: none;
}
</style>
</head>

<body>

<header>✈️ 航班数据可视化管理器</header>

<div class="toolbar">
  <button onclick="showVisual()">可视化管理</button>
  <button onclick="showRaw()" class="secondary">纯文本模式</button>
  <select id="airlineFilter"></select>
  <button onclick="saveToGitHub()">保存到 GitHub</button>
</div>

<div id="list"></div>

<textarea id="editor" class="hidden"></textarea>

<script>
/* ========= 配置 ========= */
const githubToken = "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";
const apiUrl = "https://api.github.com/repos/juicein/HJTR/contents/data/flight_data.txt";
const airportsUrl = "/data/airports.json";

/* ========= 全局 ========= */
let rawText = "";
let flights = [];
let airports = [];

/* ========= 初始化 ========= */
init();

async function init() {
  rawText = await fetchText();
  airports = await fetch(airportsUrl).then(r=>r.json());
  parseFlights();
  buildFilter();
  render();
}

/* ========= 读取 ========= */
async function fetchText() {
  const res = await fetch(apiUrl, {
    headers: { Authorization: `token ${githubToken}` }
  });
  const data = await res.json();
  return atob(data.content);
}

/* ========= 解析（不修改格式） ========= */
function parseFlights() {
  flights = rawText.match(/【[^《]+《航班结束》/g) || [];
}

/* ========= 渲染 ========= */
function render() {
  const list = document.getElementById("list");
  list.innerHTML = "";

  flights.forEach((f, i) => {
    const airline = f.match(/『(.+?)』/)?.[1] || "";
    const from = f.match(/《(.+?)出发》/)?.[1] || "";
    const to = f.match(/《(.+?)到达》/)?.[1] || "";
    const dep = f.match(/\{(\d+:\d+)\}/)?.[1] || "";
    const arr = f.match(/\{(\d+:\d+)\}#\+\d+#/)?.[1] || "";

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <h3>${from} → ${to}</h3>
      <small>${airline} ｜ ${dep} - ${arr}</small>
      <pre>${f}</pre>
      <div class="card-actions">
        <button onclick="editFlight(${i})">编辑</button>
        <button onclick="deleteFlight(${i})" class="secondary">删除</button>
      </div>
    `;
    list.appendChild(card);
  });
}

/* ========= 筛选 ========= */
function buildFilter() {
  const sel = document.getElementById("airlineFilter");
  const set = new Set(flights.map(f => f.match(/『(.+?)』/)?.[1]).filter(Boolean));
  sel.innerHTML = `<option value="">全部航空公司</option>`;
  set.forEach(a=>{
    const o = document.createElement("option");
    o.value = a;
    o.textContent = a;
    sel.appendChild(o);
  });
  sel.onchange = () => {
    const v = sel.value;
    flights = v ? rawText.match(/【[^《]+《航班结束》/g).filter(f=>f.includes(`『${v}』`)) : rawText.match(/【[^《]+《航班结束》/g);
    render();
  };
}

/* ========= 编辑 ========= */
function editFlight(i) {
  const t = prompt("直接编辑原始字符串（不会改格式）", flights[i]);
  if (t) {
    rawText = rawText.replace(flights[i], t);
    parseFlights();
    render();
  }
}

function deleteFlight(i) {
  if (!confirm("确认删除该航班？")) return;
  rawText = rawText.replace(flights[i], "");
  parseFlights();
  render();
}

/* ========= 模式切换 ========= */
function showRaw() {
  document.getElementById("list").classList.add("hidden");
  const ed = document.getElementById("editor");
  ed.classList.remove("hidden");
  ed.value = rawText;
}

function showVisual() {
  document.getElementById("list").classList.remove("hidden");
  document.getElementById("editor").classList.add("hidden");
}

/* ========= 保存 ========= */
async function saveToGitHub() {
  const ed = document.getElementById("editor");
  if (!ed.classList.contains("hidden")) {
    rawText = ed.value;
  }

  const ip = await fetch("https://api.ipify.org").then(r=>r.text());
  const device = navigator.userAgent;

  rawText += `\n# Edited by IP: ${ip} | Device: ${device} | Time: ${new Date().toLocaleString()}`;

  const sha = (await fetch(apiUrl, {
    headers: { Authorization: `token ${githubToken}` }
  }).then(r=>r.json())).sha;

  await fetch(apiUrl, {
    method: "PUT",
    headers: {
      Authorization: `token ${githubToken}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      message: "Update flight_data.txt via visual editor",
      content: btoa(unescape(encodeURIComponent(rawText))),
      sha
    })
  });

  alert("已成功写入 GitHub");
}
</script>
</body>
</html>

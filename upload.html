<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>航班数据可视化编辑器</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root {
  --primary: #006495;
  --bg: #f4f7fb;
  --card: #ffffff;
  --border: #dbe3ec;
}

body {
  margin: 0;
  background: var(--bg);
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
}

header {
  background: var(--primary);
  color: #fff;
  padding: 14px 20px;
  font-size: 18px;
}

main {
  max-width: 1100px;
  margin: 20px auto;
  padding: 0 16px;
}

.card {
  background: var(--card);
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,.08);
  overflow: hidden;
}

.toolbar {
  display: flex;
  gap: 10px;
  padding: 12px;
  border-bottom: 1px solid var(--border);
}

button {
  border: none;
  border-radius: 8px;
  padding: 8px 14px;
  cursor: pointer;
  font-size: 14px;
}

.load {
  background: #e3f2fd;
  color: #004b7a;
}

.save {
  background: #006495;
  color: white;
}

textarea {
  width: 100%;
  height: 65vh;
  border: none;
  outline: none;
  resize: none;
  padding: 16px;
  font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
  font-size: 14px;
  line-height: 1.6;
  white-space: pre;
}
.footer {
  padding: 10px 16px;
  font-size: 12px;
  color: #666;
  background: #fafafa;
}
</style>
</head>

<body>
<header>✈ 航班数据 TXT 在线编辑器（原格式保留）</header>

<main>
  <div class="card">
    <div class="toolbar">
      <button class="load" onclick="loadFile()">读取 GitHub 文件</button>
      <button class="save" onclick="saveFile()">保存并提交</button>
    </div>

    <textarea id="editor" spellcheck="false"></textarea>

    <div class="footer" id="status">
      未加载
    </div>
  </div>
</main>

<script>
/* ==========================
   ⚠️ 危险区域（内部使用）
   ========================== */

const GITHUB_TOKEN = "ghp_XXXXXXXXXXXXXXXXXXXXXXXX"; // ⚠️不要公开
const REPO = "juicein/HJTR";
const FILE_PATH = "data/flight_data.txt";

/* ========================== */

let fileSha = "";

/* 读取文件 */
async function loadFile() {
  const res = await fetch(`https://api.github.com/repos/${REPO}/contents/${FILE_PATH}`, {
    headers: {
      Authorization: "token " + GITHUB_TOKEN
    }
  });

  const data = await res.json();
  fileSha = data.sha;

  const content = decodeURIComponent(
    escape(atob(data.content))
  );

  editor.value = content;
  status.innerText = "已从 GitHub 读取";
}

/* 获取公网 IP */
async function getIP() {
  try {
    const res = await fetch("https://api.ipify.org?format=json");
    const data = await res.json();
    return data.ip;
  } catch {
    return "unknown";
  }
}

/* 保存文件 */
async function saveFile() {
  const ip = await getIP();
  const ua = navigator.userAgent;

  const contentBase64 = btoa(
    unescape(encodeURIComponent(editor.value))
  );

  const message =
    `更新航班数据\nIP: ${ip}\n设备: ${ua}\n时间: ${new Date().toLocaleString()}`;

  const res = await fetch(`https://api.github.com/repos/${REPO}/contents/${FILE_PATH}`, {
    method: "PUT",
    headers: {
      Authorization: "token " + GITHUB_TOKEN,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      message,
      content: contentBase64,
      sha: fileSha
    })
  });

  if (res.ok) {
    status.innerText = "保存成功（已写入  历史）";
  } else {
    status.innerText = "保存失败";
  }
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>航班数据编辑器</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  margin: 0;
  font-family: system-ui, -apple-system;
  background: #f4f7fb;
}

header {
  background: #006495;
  color: white;
  padding: 14px 20px;
  font-size: 18px;
}

main {
  max-width: 1100px;
  margin: 20px auto;
  padding: 0 16px;
}

.card {
  background: white;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,.08);
  overflow: hidden;
}

.toolbar {
  display: flex;
  gap: 10px;
  padding: 12px;
  border-bottom: 1px solid #ddd;
}

button {
  border: none;
  border-radius: 8px;
  padding: 8px 14px;
  cursor: pointer;
}

.load { background: #e3f2fd; }
.save { background: #006495; color: white; }

textarea {
  width: 100%;
  height: 65vh;
  border: none;
  outline: none;
  resize: none;
  padding: 16px;
  font-family: ui-monospace, monospace;
  white-space: pre;
  font-size: 14px;
}

dialog {
  border: none;
  border-radius: 10px;
  padding: 20px;
  box-shadow: 0 10px 40px rgba(0,0,0,.3);
}

dialog button {
  margin-top: 12px;
}
</style>
</head>

<body>
<header>✈ 航班数据 TXT 在线编辑</header>

<main>
  <div class="card">
    <div class="toolbar">
      <button class="save" onclick="saveFile()">保存到 GitHub</button>
    </div>

    <textarea id="editor"></textarea>
  </div>
</main>

<dialog id="msgBox">
  <div id="msgText"></div>
  <button onclick="msgBox.close()">确定</button>
</dialog>

<script>
const GITHUB_TOKEN = "ghp_XXXXXXXXXXXXXXXXXXXX"; // ⚠️内部使用
const REPO = "juicein/HJTR";
const FILE_PATH = "data/flight_data.txt";

let fileSha = "";

const editor = document.getElementById("editor");
const msgBox = document.getElementById("msgBox");
const msgText = document.getElementById("msgText");

function showMsg(text) {
  msgText.innerText = text;
  msgBox.showModal();
}

/* 自动加载 */
document.addEventListener("DOMContentLoaded", loadFile);

/* 加载文件 */
async function loadFile() {
  try {
    const res = await fetch(
      `https://api.github.com/repos/${REPO}/contents/${FILE_PATH}`,
      {
        headers: { Authorization: "token " + GITHUB_TOKEN }
      }
    );

    if (!res.ok) {
      throw new Error("无法读取文件：" + res.status);
    }

    const data = await res.json();
    fileSha = data.sha;

    editor.value = decodeURIComponent(
      escape(atob(data.content))
    );

  } catch (e) {
    showMsg("加载失败\n" + e.message);
  }
}

/* 获取 IP */
async function getIP() {
  try {
    const r = await fetch("https://api.ipify.org?format=json");
    const j = await r.json();
    return j.ip;
  } catch {
    return "unknown";
  }
}

/* 保存 */
async function saveFile() {
  if (!fileSha) {
    showMsg("未加载原文件，无法保存");
    return;
  }

  try {
    const ip = await getIP();
    const content = btoa(
      unescape(encodeURIComponent(editor.value))
    );

    const res = await fetch(
      `https://api.github.com/repos/${REPO}/contents/${FILE_PATH}`,
      {
        method: "PUT",
        headers: {
          Authorization: "token " + GITHUB_TOKEN,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          message: `更新航班数据\nIP:${ip}\n设备:${navigator.userAgent}`,
          content,
          sha: fileSha
        })
      }
    );

    const result = await res.json();

    if (!res.ok) {
      throw new Error(result.message || "保存失败");
    }

    fileSha = result.content.sha;
    showMsg("✅ 保存成功，已写入 历史");

  } catch (e) {
    showMsg("❌ 保存失败\n" + e.message);
  }
}
</script>
</body>
</html>

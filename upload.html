export default {
  async fetch(req, env) {
    const GITHUB_API =
      "https://api.github.com/repos/juicein/HJTR/contents/data/flight_data.txt";

    const headers = {
      "Authorization": `token ${env.GITHUB_TOKEN}`,
      "User-Agent": "flight-wiki-editor",
      "Accept": "application/vnd.github.v3.raw"
    };

    // ===== 读取 =====
    if (req.method === "GET") {
      const gh = await fetch(GITHUB_API, { headers });

      if (!gh.ok) {
        return new Response("读取 GitHub 文件失败", { status: 500 });
      }

      // ⚠️ 关键：不要 text()，不要 JSON
      const buffer = await gh.arrayBuffer();

      return new Response(buffer, {
        headers: {
          "Content-Type": "text/plain; charset=utf-8"
        }
      });
    }

    // ===== 写入 =====
    if (req.method === "POST") {
      const { content, password } = await req.json();

      // 简单口令示例（你可扩展）
      if (!["1693076637"].includes(password)) {
        return new Response("无权限", { status: 403 });
      }

      // 先拿 SHA
      const meta = await fetch(GITHUB_API, { headers }).then(r => r.json());

      const body = {
        message: `Wiki 编辑 @ ${req.headers.get("CF-Connecting-IP")}`,
        content: btoa(unescape(encodeURIComponent(content))), // UTF-8 → Base64
        sha: meta.sha
      };

      const put = await fetch(GITHUB_API, {
        method: "PUT",
        headers: {
          ...headers,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
      });

      return new Response(put.ok ? "ok" : "fail");
    }

    return new Response("Method Not Allowed", { status: 405 });
  }
};

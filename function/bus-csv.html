<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>å…¬äº¤ / è½¨é“ æ•°æ®è½¬æ¢å™¨</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
/* ===== Material 3 Expressiveï¼ˆçº¯ CSSï¼‰===== */
:root{
  --md-primary:#6750A4;
  --md-surface:#FFFBFE;
  --md-outline:#CAC4D0;
  --md-radius:16px;
}
body{
  margin:0;
  font-family: system-ui,-apple-system;
  background:var(--md-surface);
  color:#1C1B1F;
}
header{
  padding:20px;
  font-size:22px;
  font-weight:600;
}
.card{
  margin:16px;
  padding:16px;
  border-radius:var(--md-radius);
  background:#fff;
  box-shadow:0 1px 6px rgba(0,0,0,.1);
}
select,button,textarea,input{
  width:100%;
  margin-top:10px;
  padding:12px;
  border-radius:12px;
  border:1px solid var(--md-outline);
  font-size:15px;
}
button{
  background:var(--md-primary);
  color:#fff;
  border:none;
}
button.secondary{
  background:#E8DEF8;
  color:#21005D;
}
textarea{
  height:180px;
  font-family:monospace;
}
.row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.row button{flex:1}
</style>
</head>

<body>
<header>ğŸšŒ å…¬äº¤ / è½¨é“ æ•°æ®è½¬æ¢å™¨</header>

<div class="card">
  <b>â‘  é€‰æ‹©åœ°åŒº</b>
  <select id="areaSelect"></select>
  <button onclick="exportCSV()">å¯¼å‡ºè¯¥åœ°åŒº CSV</button>
</div>

<div class="card">
  <b>â‘¡ å¯¼å…¥ä¿®æ”¹åçš„ CSV</b>
  <input type="file" accept=".csv" onchange="importCSV(this.files[0])">
</div>

<div class="card">
  <b>â‘¢ è½¬æ¢ç»“æœï¼ˆåŸå§‹æ ¼å¼ï¼‰</b>
  <textarea id="output"></textarea>
  <div class="row">
    <button class="secondary" onclick="copyText()">å¤åˆ¶</button>
    <button class="secondary" onclick="shareText()">ç³»ç»Ÿåˆ†äº«</button>
    <button class="secondary" onclick="downloadTXT()">å¯¼å‡º TXT</button>
  </div>
</div>

<script>
let rawLines = [];
let parsed = [];

/* ===== è‡ªåŠ¨è¯»å– bus_data.txt ===== */
fetch('data/bus_data.txt')
.then(r => r.text())
.then(t => {
  rawLines = t.split(/\n+/).filter(l => l.trim());
  parseData();
});

/* ===== è§£æåŸå§‹æ•°æ® ===== */
function parseData(){
  parsed = [];
  const areas = new Set();

  rawLines.forEach(l => {

    const line = l.match(/ã€(.+?)ã€‘/)?.[1] || '';
    const stations = l.split('ã€‘')[1].split('-{')[0];
    const company = l.match(/\{(.+?)\}/)?.[1] || '';
    const price = l.match(/ã€Š(.+?)ã€‹/)?.[1] || '';
    const area = l.match(/ã€(.+?)ã€/)?.[1] || 'æœªçŸ¥';
    const start = l.match(/Â§(.+?)Â§/)?.[1] || '';
    const end = l.match(/@(.+?)@/)?.[1] || '';
    const color = l.match(/âˆ®(.+?)âˆ®/)?.[1] || '';

    /* âœ… çº¿è·¯ç±»å‹ï¼šå®Œå…¨æŒ‰ Î¸å†…å®¹Î¸ åŸæ ·è¯»å– */
    let type = 'å…¬äº¤';
    const typeMatch = l.match(/Î¸(.+?)Î¸/);
    if(typeMatch) type = typeMatch[1];

    areas.add(area);

    parsed.push({
      line, stations, company, price,
      area, type, start, end, color
    });
  });

  const sel = document.getElementById('areaSelect');
  sel.innerHTML = [...areas].map(a => `<option>${a}</option>`).join('');
}

/* ===== å¯¼å‡º CSV ===== */
function exportCSV(){
  const area = areaSelect.value;
  let csv = 'line,stations,company,price,area,type,start_time,end_time,color\n';

  parsed.filter(p => p.area === area).forEach(p => {
    csv += `"${p.line}","${p.stations}","${p.company}","${p.price}","${p.area}","${p.type}","${p.start}","${p.end}","${p.color}"\n`;
  });

  download(csv, 'bus_' + area + '.csv', 'text/csv');
}

/* ===== CSV â†’ åŸå§‹æ ¼å¼ ===== */
function importCSV(file){
  const r = new FileReader();
  r.onload = () => {
    const rows = r.result.split('\n').slice(1);
    let out = '';

    rows.forEach(row => {
      if(!row.trim()) return;

      const c = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g)
                   .map(s => s.replace(/^"|"$/g,''));

      let txt = `ã€${c[0]}ã€‘${c[1]}-{${c[2]}}ã€Š${c[3]}ã€‹ã€${c[4]}ã€`;

      /* âœ… åªè¦ä¸æ˜¯â€œå…¬äº¤â€ï¼Œå°±å†™å› Î¸ç±»å‹Î¸ */
      if(c[5] && c[5] !== 'å…¬äº¤'){
        txt += `Î¸${c[5]}Î¸`;
      }

      txt += `Â§${c[6]}Â§@${c[7]}@`;

      if(c[8]) txt += `âˆ®${c[8]}âˆ®`;

      out += txt + '\n';
    });

    output.value = out;
  };
  r.readAsText(file, 'utf-8');
}

/* ===== å·¥å…·å‡½æ•° ===== */
function copyText(){
  navigator.clipboard.writeText(output.value);
}
function shareText(){
  navigator.share?.({ text: output.value });
}
function downloadTXT(){
  download(output.value, 'bus_converted.txt', 'text/plain');
}
function download(data, name, type){
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([data], {type}));
  a.download = name;
  a.click();
}
</script>
</body>
</html>

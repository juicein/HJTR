<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>å…¬äº¤ / è½¨é“ æ•°æ®åŒå‘è½¬æ¢å™¨</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

<style>
:root{
  --md-primary:#6750A4;
  --md-surface:#FFFBFE;
  --md-outline:#CAC4D0;
  --md-radius:16px;
}
body{
  margin:0;
  font-family:system-ui,-apple-system;
  background:var(--md-surface);
}
header{padding:20px;font-size:22px;font-weight:600;}
.card{
  margin:16px;padding:16px;border-radius:16px;
  background:#fff;box-shadow:0 1px 6px rgba(0,0,0,.1);
}
select,button,input,textarea{
  width:100%;margin-top:10px;padding:12px;
  border-radius:12px;border:1px solid var(--md-outline);
}
button{background:var(--md-primary);color:#fff;border:none;}
button.secondary{background:#E8DEF8;color:#21005D;}
textarea{height:180px;font-family:monospace;}
pre{background:#f6f6f6;padding:10px;border-radius:12px;white-space:pre-wrap;}
</style>
</head>

<body>
<header>ğŸšŒ å…¬äº¤ / è½¨é“ æ•°æ®åŒå‘è½¬æ¢å™¨ï¼ˆç¨³å®šç‰ˆï¼‰</header>

<div class="card">
<b>â‘  é€‰æ‹©åœ°åŒº</b>
<select id="areaSelect"></select>
<button onclick="exportExcel()">å¯¼å‡º Excel</button>
<button onclick="exportCSV()">å¯¼å‡º CSV</button>
</div>

<div class="card">
<b>â‘¡ å¯¼å…¥ CSV / Excel</b>
<input type="file" accept=".csv,.xlsx" onchange="importFile(this.files[0])">
</div>

<div class="card">
<b>â‘¢ è½¬æ¢ç»“æœ</b>
<textarea id="output"></textarea>
<button class="secondary" onclick="copyText()">å¤åˆ¶</button>
<button class="secondary" onclick="downloadTXT()">å¯¼å‡º TXT</button>
</div>

<div class="card">
<b>âš  è§£ææ—¥å¿—</b>
<pre id="log"></pre>
</div>

<script>
let parsed = [];

/* ===== è¯»å–åŸå§‹æ•°æ® ===== */
fetch('../data/bus_data.txt').then(r=>r.text()).then(t=>{
  t.split(/\n+/).forEach(l=>{
    const area = l.match(/ã€(.+?)ã€/)?.[1];
    if(area) parsed.push({area});
  });
  areaSelect.innerHTML = [...new Set(parsed.map(p=>p.area))]
    .map(a=>`<option>${a}</option>`).join('');
});

/* ===== å¯¼å…¥åˆ†æµ ===== */
function importFile(file){
  log.textContent='';
  if(file.name.endsWith('.xlsx')) importExcel(file);
  else if(file.name.endsWith('.csv')) importCSV(file);
  else log.textContent='ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹';
}

/* ===== CSVï¼ˆUTF-8 / GBK è‡ªåŠ¨ï¼‰ ===== */
function importCSV(file){
  const reader = new FileReader();
  reader.onload = () => {
    let text = reader.result;
    if(text.includes('ï¿½')){ logLine('æ£€æµ‹åˆ°ä¹±ç ï¼Œå°è¯• GBK è§£ç '); }
    parseTable(parseCSV(text));
  };
  reader.readAsText(file,'utf-8');
}

/* ===== Excel ===== */
function importExcel(file){
  const r = new FileReader();
  r.onload = e => {
    const wb = XLSX.read(new Uint8Array(e.target.result),{type:'array'});
    const ws = wb.Sheets[wb.SheetNames[0]];
    parseTable(XLSX.utils.sheet_to_json(ws));
  };
  r.readAsArrayBuffer(file);
}

/* ===== CSV â†’ å¯¹è±¡æ•°ç»„ ===== */
function parseCSV(text){
  const lines = text.replace(/\r/g,'').split('\n');
  const headers = lines.shift().split(',');
  return lines.map(l=>{
    const cols = l.split(',');
    const obj={};
    headers.forEach((h,i)=>obj[h.trim()]=cols[i]?.trim());
    return obj;
  });
}

/* ===== è¡¨æ ¼ â†’ åŸå§‹æ ¼å¼ ===== */
function parseTable(rows){
  let out='';
  rows.forEach((r,i)=>{
    if(!r.line || !r.area){
      logLine(`ç¬¬ ${i+2} è¡Œç¼ºå°‘ line / areaï¼Œå·²è·³è¿‡`);
      return;
    }
    let txt=`ã€${r.line}ã€‘${r.stations||''}-{${r.company||''}}ã€Š${r.price||''}ã€‹ã€${r.area}ã€`;
    if(r.type && r.type!=='å…¬äº¤') txt+=`Î¸${r.type}Î¸`;
    txt+=`Â§${r.start_time||''}Â§@${r.end_time||''}@`;
    if(r.color) txt+=`âˆ®${r.color}âˆ®`;
    out+=txt+'\n';
  });
  output.value=out;
}

/* ===== å¯¼å‡º ===== */
function exportCSV(){
  download(output.value,'bus.csv','text/plain');
}
function exportExcel(){
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.aoa_to_sheet([['åŸå§‹æ•°æ®'],[output.value]]);
  XLSX.utils.book_append_sheet(wb,ws,'data');
  XLSX.writeFile(wb,'bus.xlsx');
}

function logLine(t){ log.textContent+=t+'\n'; }
function copyText(){ navigator.clipboard.writeText(output.value); }
function downloadTXT(){ download(output.value,'bus.txt','text/plain'); }
function download(data,name,type){
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([data],{type}));
  a.download=name;a.click();
}
</script>
</body>
</html>

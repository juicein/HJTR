<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>公交 / 轨道 数据双向转换器</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- SheetJS（Excel 解析与导出） -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

<style>
/* ===== Material 3 Expressive ===== */
:root{
  --md-primary:#6750A4;
  --md-surface:#FFFBFE;
  --md-outline:#CAC4D0;
  --md-radius:16px;
}
body{
  margin:0;
  font-family:system-ui,-apple-system;
  background:var(--md-surface);
  color:#1C1B1F;
}
header{
  padding:20px;
  font-size:22px;
  font-weight:600;
}
.card{
  margin:16px;
  padding:16px;
  border-radius:var(--md-radius);
  background:#fff;
  box-shadow:0 1px 6px rgba(0,0,0,.1);
}
select,button,input,textarea{
  width:100%;
  margin-top:10px;
  padding:12px;
  border-radius:12px;
  border:1px solid var(--md-outline);
  font-size:15px;
}
button{
  background:var(--md-primary);
  color:#fff;
  border:none;
}
button.secondary{
  background:#E8DEF8;
  color:#21005D;
}
textarea{
  height:200px;
  font-family:monospace;
}
.row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.row button{flex:1}
</style>
</head>

<body>
<header> 数据转换器</header>

<div class="card">
  <b>① 选择地区</b>
  <select id="areaSelect"></select>
  <div class="row">
    <button onclick="exportCSV()">导出 CSV</button>
    <button onclick="exportExcel()">导出 Excel</button>
  </div>
</div>

<div class="card">
  <b>② 导入 CSV / Excel</b>
  <input type="file" accept=".csv,.xlsx" onchange="importFile(this.files[0])">
</div>

<div class="card">
  <b>③ 转换结果（原始格式）</b>
  <textarea id="output"></textarea>
  <div class="row">
    <button class="secondary" onclick="copyText()">复制</button>
    <button class="secondary" onclick="shareText()">系统分享</button>
    <button class="secondary" onclick="downloadTXT()">导出 TXT</button>
  </div>
</div>

<script>
let rawLines = [];
let parsed = [];

/* ===== 读取 bus_data.txt ===== */
fetch('../data/bus_data.txt')
.then(r => r.text())
.then(t => {
  rawLines = t.split(/\n+/).filter(l => l.trim());
  parseData();
});

/* ===== 解析原始格式 ===== */
function parseData(){
  parsed = [];
  const areas = new Set();

  rawLines.forEach(l => {
    const line = l.match(/【(.+?)】/)?.[1] || '';
    const stations = l.split('】')[1].split('-{')[0];
    const company = l.match(/\{(.+?)\}/)?.[1] || '';
    const price = l.match(/《(.+?)》/)?.[1] || '';
    const area = l.match(/『(.+?)』/)?.[1] || '未知';
    const start = l.match(/§(.+?)§/)?.[1] || '';
    const end = l.match(/@(.+?)@/)?.[1] || '';
    const color = l.match(/∮(.+?)∮/)?.[1] || '';

    let type = '公交';
    const typeMatch = l.match(/θ(.+?)θ/);
    if(typeMatch) type = typeMatch[1];

    areas.add(area);

    parsed.push({
      line, stations, company, price,
      area, type, start, end, color
    });
  });

  areaSelect.innerHTML =
    [...areas].map(a => `<option>${a}</option>`).join('');
}

/* ===== 导出 CSV ===== */
function exportCSV(){
  const area = areaSelect.value;
  let csv =
    'line,stations,company,price,area,type,start_time,end_time,color\n';

  parsed.filter(p => p.area === area).forEach(p => {
    csv += `"${p.line}","${p.stations}","${p.company}","${p.price}","${p.area}","${p.type}","${p.start}","${p.end}","${p.color}"\n`;
  });

  download(csv, `bus_${area}.csv`, 'text/csv');
}

/* ===== 导出 Excel ===== */
function exportExcel(){
  const area = areaSelect.value;

  const rows = [
    ['line','stations','company','price','area','type','start_time','end_time','color']
  ];

  parsed.filter(p => p.area === area).forEach(p => {
    rows.push([
      p.line, p.stations, p.company, p.price,
      p.area, p.type, p.start, p.end, p.color
    ]);
  });

  const ws = XLSX.utils.aoa_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'data');

  XLSX.writeFile(wb, `bus_${area}.xlsx`);
}

/* ===== 导入分流 ===== */
function importFile(file){
  if(file.name.endsWith('.csv')){
    importCSV(file);
  }else if(file.name.endsWith('.xlsx')){
    importExcel(file);
  }else{
    alert('不支持的文件格式');
  }
}

/* ===== CSV → 原始格式 ===== */
function importCSV(file){
  const r = new FileReader();
  r.onload = () => {
    convertRows(
      r.result.split('\n').slice(1)
      .map(row => row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g)
      ?.map(s => s.replace(/^"|"$/g,'')))
    );
  };
  r.readAsText(file, 'utf-8');
}

/* ===== Excel → 原始格式 ===== */
function importExcel(file){
  const r = new FileReader();
  r.onload = e => {
    const wb = XLSX.read(
      new Uint8Array(e.target.result),
      { type:'array' }
    );
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws, { header:1 }).slice(1);
    convertRows(rows);
  };
  r.readAsArrayBuffer(file);
}

/* ===== 行数据 → 原始格式 ===== */
function convertRows(rows){
  let out = '';
  rows.forEach(c => {
    if(!c || !c.length) return;

    let txt = `【${c[0]}】${c[1]}-{${c[2]}}《${c[3]||''}》『${c[4]}』`;

    if(c[5] && c[5] !== '公交'){
      txt += `θ${c[5]}θ`;
    }

    txt += `§${c[6]||''}§@${c[7]||''}@`;

    if(c[8]) txt += `∮${c[8]}∮`;

    out += txt + '\n';
  });
  output.value = out;
}

/* ===== 工具 ===== */
function copyText(){
  navigator.clipboard.writeText(output.value);
}
function shareText(){
  navigator.share?.({ text: output.value });
}
function downloadTXT(){
  download(output.value,'bus_converted.txt','text/plain');
}
function download(data,name,type){
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([data],{type}));
  a.download=name;
  a.click();
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bus Data Tool</title>

<!-- Material 3 -->
<script type="module" src="https://unpkg.com/@material/web/all.js"></script>

<style>
  body {
    margin: 0;
    font-family: system-ui, -apple-system;
    background: #fef7ff;
    color: #1d1b20;
  }
  header {
    padding: 24px;
    font-size: 22px;
    font-weight: 600;
  }
  main {
    padding: 16px;
    max-width: 900px;
    margin: auto;
  }
  md-elevated-card {
    padding: 16px;
    margin-bottom: 16px;
    border-radius: 28px;
  }
  textarea {
    width: 100%;
    height: 160px;
    font-family: monospace;
    font-size: 13px;
    padding: 12px;
    border-radius: 16px;
    border: none;
    resize: vertical;
    background: #f3edf7;
  }
  .row {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    align-items: center;
  }
  .list {
    font-size: 14px;
    line-height: 1.6;
    white-space: pre-wrap;
  }
</style>
</head>

<body>

<header>ğŸšŒ å…¬äº¤ / åœ°é“ æ•°æ®æ ¼å¼è½¬æ¢å·¥å…·</header>

<main>

<!-- åŸå§‹æ•°æ®è¾“å…¥ -->
<md-elevated-card>
  <h3>åŸå§‹æ•°æ®åº“æ ¼å¼</h3>
  <textarea id="rawInput" placeholder="ç²˜è´´ bus_data.txt å†…å®¹"></textarea>
  <div class="row" style="margin-top:12px">
    <md-filled-button onclick="loadRaw()">è§£ææ•°æ®</md-filled-button>
  </div>
</md-elevated-card>

<!-- åœ°åŒºé€‰æ‹© -->
<md-elevated-card>
  <h3>åœ°åŒºé€‰æ‹©</h3>
  <md-filled-select id="areaSelect" onchange="filterArea()">
    <md-select-option value="all">
      <div slot="headline">å…¨éƒ¨åœ°åŒº</div>
    </md-select-option>
  </md-filled-select>
</md-elevated-card>

<!-- çº¿è·¯åˆ—è¡¨ -->
<md-elevated-card>
  <h3>çº¿è·¯åˆ—è¡¨</h3>
  <div id="lineList" class="list"></div>
  <div class="row" style="margin-top:12px">
    <md-tonal-button onclick="exportCSV()">å¯¼å‡º CSV</md-tonal-button>
  </div>
</md-elevated-card>

<!-- CSV è½¬æ¢ -->
<md-elevated-card>
  <h3>CSV â†’ åŸå§‹æ ¼å¼</h3>
  <textarea id="csvInput" placeholder="ç²˜è´´æˆ–ä¸Šä¼ ä¿®æ”¹åçš„ CSV"></textarea>
  <div class="row" style="margin-top:12px">
    <md-filled-button onclick="convertCSV()">è½¬æ¢</md-filled-button>
    <md-outlined-button onclick="copyResult()">å¤åˆ¶</md-outlined-button>
    <md-outlined-button onclick="downloadTXT()">å¯¼å‡º TXT</md-outlined-button>
    <md-outlined-button onclick="share()">ç³»ç»Ÿåˆ†äº«</md-outlined-button>
  </div>
</md-elevated-card>

<!-- è¾“å‡º -->
<md-elevated-card>
  <h3>è½¬æ¢ç»“æœ</h3>
  <div id="output" class="list"></div>
</md-elevated-card>

</main>

<script>
let parsed = [];
let filtered = [];

/* ---------- è§£æåŸå§‹æ•°æ® ---------- */
function loadRaw() {
  const text = rawInput.value.trim();
  if (!text) return;

  parsed = text.split('\n').filter(Boolean).map(line => ({
    raw: line,
    line: line.match(/ã€(.*?)ã€‘/)?.[1],
    area: line.match(/ã€(.*?)ã€/)?.[1] || 'æœªçŸ¥',
    company: line.match(/\-\{(.*?)\}/)?.[1] || '',
    first: line.match(/Â§(.*?)Â§/)?.[1] || '',
    last: line.match(/@(.*?)@/)?.[1] || '',
    stops: line.split('ã€‘')[1]?.split('-{')[0] || ''
  }));

  const areas = [...new Set(parsed.map(d => d.area))];
  areaSelect.innerHTML = `
    <md-select-option value="all">
      <div slot="headline">å…¨éƒ¨åœ°åŒº</div>
    </md-select-option>
    ${areas.map(a =>
      `<md-select-option value="${a}">
        <div slot="headline">${a}</div>
      </md-select-option>`
    ).join('')}
  `;

  filterArea();
}

/* ---------- åœ°åŒºç­›é€‰ ---------- */
function filterArea() {
  const area = areaSelect.value;
  filtered = area === 'all'
    ? parsed
    : parsed.filter(d => d.area === area);

  lineList.textContent = filtered.map(d =>
    `ã€${d.line}ã€‘ ${d.area} Â· ${d.company}\né¦– ${d.first}  æœ« ${d.last}\n`
  ).join('\n');
}

/* ---------- CSV å¯¼å‡º ---------- */
function exportCSV() {
  const header = 'line,area,company,stops,first,last';
  const rows = filtered.map(d =>
    `"${d.line}","${d.area}","${d.company}","${d.stops.replace(/"/g,'')}","${d.first}","${d.last}"`
  );
  const csv = [header, ...rows].join('\n');

  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'bus_data.csv';
  a.click();
}

/* ---------- CSV â†’ åŸå§‹ ---------- */
function convertCSV() {
  const lines = csvInput.value.trim().split('\n');
  if (lines.length < 2) return;

  const keys = lines.shift().split(',');
  const result = lines.map(l => {
    const v = l.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g)
      .map(s => s.replace(/^"|"$/g, ''));
    const o = Object.fromEntries(keys.map((k,i)=>[k,v[i]]));
    return `ã€${o.line}ã€‘${o.stops}-{${o.company}}ã€Šã€‹ã€${o.area}ã€Â§${o.first}Â§@${o.last}@`;
  }).join('\n');

  output.textContent = result;
}

/* ---------- è¾“å‡ºæ“ä½œ ---------- */
function copyResult() {
  navigator.clipboard.writeText(output.textContent);
}
function downloadTXT() {
  const blob = new Blob([output.textContent], { type: 'text/plain' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'bus_data.txt';
  a.click();
}
function share() {
  if (navigator.share) {
    navigator.share({ text: output.textContent });
  }
}
</script>

</body>
</html>

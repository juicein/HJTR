<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>å…¬äº¤ / è½¨é“ æ•°æ®åŒå‘è½¬æ¢å™¨</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

<style>
:root{
  --md-primary:#6750A4;
  --md-surface:#FFFBFE;
  --md-outline:#CAC4D0;
  --md-radius:16px;
}
body{
  margin:0;
  font-family:system-ui,-apple-system;
  background:var(--md-surface);
}
header{
  padding:20px;
  font-size:22px;
  font-weight:600;
}
.card{
  margin:16px;
  padding:16px;
  background:#fff;
  border-radius:var(--md-radius);
  box-shadow:0 1px 6px rgba(0,0,0,.1);
}
select,button,input,textarea{
  width:100%;
  margin-top:10px;
  padding:12px;
  border-radius:12px;
  border:1px solid var(--md-outline);
}
button{
  background:var(--md-primary);
  color:#fff;
  border:none;
}
button.secondary{
  background:#E8DEF8;
  color:#21005D;
}
textarea{
  height:220px;
  font-family:monospace;
}
.row{
  display:flex;
  gap:10px;
}
.row button{flex:1}
</style>
</head>

<body>
<header>ğŸšŒ å…¬äº¤ / è½¨é“ æ•°æ®åŒå‘è½¬æ¢å™¨</header>

<div class="card">
  <b>â‘  é€‰æ‹©åœ°åŒº</b>
  <select id="areaSelect"></select>
  <div class="row">
    <button onclick="exportCSV()">å¯¼å‡º CSV</button>
    <button onclick="exportExcel()">å¯¼å‡º Excel</button>
  </div>
</div>

<div class="card">
  <b>â‘¡ å¯¼å…¥ CSV / Excel</b>
  <input type="file" accept=".csv,.xlsx" onchange="importFile(this.files[0])">
</div>

<div class="card">
  <b>â‘¢ è½¬æ¢ç»“æœï¼ˆåŸå§‹æ ¼å¼ï¼‰</b>
  <textarea id="output"></textarea>
  <div class="row">
    <button class="secondary" onclick="copyText()">å¤åˆ¶</button>
    <button class="secondary" onclick="shareText()">ç³»ç»Ÿåˆ†äº«</button>
    <button class="secondary" onclick="downloadTXT()">å¯¼å‡º TXT</button>
  </div>
</div>

<script>
let parsed=[];

/* ===== è¯»å–åŸå§‹ txt ===== */
fetch('../data/bus_data.txt')
.then(r=>r.text())
.then(t=>{
  t.split(/\n+/).filter(Boolean).forEach(l=>{
    const typeMatch=l.match(/Î¸(.+?)Î¸/);
    parsed.push({
      line:l.match(/ã€(.+?)ã€‘/)?.[1]||'',
      stations:l.split('ã€‘')[1]?.split('-{')[0]||'',
      company:l.match(/\{(.+?)\}/)?.[1]||'',
      price:l.match(/ã€Š(.+?)ã€‹/)?.[1]||'',
      area:l.match(/ã€(.+?)ã€/)?.[1]||'æœªçŸ¥',
      type:typeMatch?typeMatch[1]:'å…¬äº¤',
      start:l.match(/Â§(.+?)Â§/)?.[1]||'',
      end:l.match(/@(.+?)@/)?.[1]||'',
      color:l.match(/âˆ®(.+?)âˆ®/)?.[1]||''
    });
  });
  areaSelect.innerHTML=[...new Set(parsed.map(p=>p.area))]
    .map(a=>`<option>${a}</option>`).join('');
});

/* ===== å¯¼å‡º ===== */
function exportCSV(){
  const area=areaSelect.value;
  let csv='line,stations,company,price,area,type,start_time,end_time,color\n';
  parsed.filter(p=>p.area===area).forEach(p=>{
    csv+=Object.values({
      line:p.line,stations:p.stations,company:p.company,
      price:p.price,area:p.area,type:p.type,
      start_time:p.start,end_time:p.end,color:p.color
    }).map(v=>`"${v||''}"`).join(',')+'\n';
  });
  download(csv,`bus_${area}.csv`,'text/csv');
}

function exportExcel(){
  const area=areaSelect.value;
  const rows=[['line','stations','company','price','area','type','start_time','end_time','color']];
  parsed.filter(p=>p.area===area).forEach(p=>{
    rows.push([p.line,p.stations,p.company,p.price,p.area,p.type,p.start,p.end,p.color]);
  });
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(rows),'data');
  XLSX.writeFile(wb,`bus_${area}.xlsx`);
}

/* ===== å¯¼å…¥ ===== */
function importFile(file){
  file.name.endsWith('.xlsx') ? importExcel(file) : importCSV(file);
}

function importExcel(file){
  const r=new FileReader();
  r.onload=e=>{
    const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});
    const ws=wb.Sheets[wb.SheetNames[0]];
    convertJSON(XLSX.utils.sheet_to_json(ws,{defval:''}));
  };
  r.readAsArrayBuffer(file);
}

function importCSV(file){
  const r=new FileReader();
  r.onload=()=>{
    const [h,...lines]=r.result.split('\n');
    const keys=h.split(',').map(s=>s.trim());
    convertJSON(lines.map(l=>{
      const v=l.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g)||[];
      const o={};
      keys.forEach((k,i)=>o[k]=v[i]?.replace(/^"|"$/g,'')||'');
      return o;
    }));
  };
  r.readAsText(file,'utf-8');
}

/* ===== JSON â†’ åŸå§‹æ ¼å¼ ===== */
function convertJSON(rows){
  output.value='';
  rows.forEach(r=>{
    if(!r.line) return;
    let txt=`ã€${r.line}ã€‘${r.stations}-{${r.company}}ã€Š${r.price||''}ã€‹ã€${r.area}ã€`;
    if(r.type && r.type!=='å…¬äº¤') txt+=`Î¸${r.type}Î¸`;
    txt+=`Â§${r.start_time||''}Â§@${r.end_time||''}@`;
    if(r.color) txt+=`âˆ®${r.color}âˆ®`;
    output.value+=txt+'\n';
  });
}

/* ===== å·¥å…· ===== */
function copyText(){navigator.clipboard.writeText(output.value);}
function shareText(){navigator.share?.({text:output.value});}
function downloadTXT(){download(output.value,'bus_converted.txt','text/plain');}
function download(d,n,t){
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([d],{type:t}));
  a.download=n;a.click();
}
</script>
</body>
</html>

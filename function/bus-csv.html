<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>å…¬äº¤ / è½¨é“ æ•°æ®åŒå‘è½¬æ¢å™¨</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

<style>
:root{
  --md-primary:#6750A4;
  --md-surface:#FFFBFE;
  --md-outline:#CAC4D0;
  --md-radius:16px;
}
body{
  margin:0;
  font-family:system-ui,-apple-system;
  background:var(--md-surface);
  color:#1C1B1F;
}
header{padding:20px;font-size:22px;font-weight:600}
.card{
  margin:16px;padding:16px;border-radius:16px;
  background:#fff;box-shadow:0 1px 6px rgba(0,0,0,.1)
}
select,button,input,textarea{
  width:100%;margin-top:10px;padding:12px;
  border-radius:12px;border:1px solid var(--md-outline);
}
button{background:var(--md-primary);color:#fff;border:none}
button.secondary{background:#E8DEF8;color:#21005D}
textarea{height:200px;font-family:monospace}
.row{display:flex;gap:10px}
.row button{flex:1}
</style>
</head>

<body>
<header>ğŸšŒ å…¬äº¤ / è½¨é“ æ•°æ®åŒå‘è½¬æ¢å™¨</header>

<div class="card">
  <b>â‘  é€‰æ‹©åœ°åŒº</b>
  <select id="areaSelect"></select>
  <div class="row">
    <button onclick="exportCSV()">å¯¼å‡º CSV</button>
    <button onclick="exportExcel()">å¯¼å‡º Excel</button>
  </div>
</div>

<div class="card">
  <b>â‘¡ å¯¼å…¥ CSV / Excel</b>
  <input type="file" accept=".csv,.xlsx" onchange="importFile(this.files[0])">
</div>

<div class="card">
  <b>â‘¢ è½¬æ¢ç»“æœï¼ˆåŸå§‹æ ¼å¼ï¼‰</b>
  <textarea id="output"></textarea>
  <div class="row">
    <button class="secondary" onclick="copyText()">å¤åˆ¶</button>
    <button class="secondary" onclick="downloadTXT()">å¯¼å‡º TXT</button>
  </div>
</div>

<script>
let rawLines=[], parsed=[];

/* ===== è¯»å–åŸå§‹æ•°æ® ===== */
fetch('../data/bus_data.txt')
.then(r=>r.text())
.then(t=>{
  rawLines=t.split(/\n+/).filter(Boolean);
  parseData();
});

function parseData(){
  parsed=[];
  const areas=new Set();

  rawLines.forEach(l=>{
    const typeMatch=l.match(/Î¸(.+?)Î¸/);
    parsed.push({
      line:l.match(/ã€(.+?)ã€‘/)?.[1]||'',
      stations:l.split('ã€‘')[1].split('-{')[0],
      company:l.match(/\{(.+?)\}/)?.[1]||'',
      price:l.match(/ã€Š(.+?)ã€‹/)?.[1]||'',
      area:l.match(/ã€(.+?)ã€/)?.[1]||'æœªçŸ¥',
      type:typeMatch?typeMatch[1]:'å…¬äº¤',
      start:l.match(/Â§(.+?)Â§/)?.[1]||'',
      end:l.match(/@(.+?)@/)?.[1]||'',
      color:l.match(/âˆ®(.+?)âˆ®/)?.[1]||''
    });
    areas.add(parsed.at(-1).area);
  });

  areaSelect.innerHTML=[...areas].map(a=>`<option>${a}</option>`).join('');
}

/* ===== å¯¼å‡º ===== */
function exportCSV(){
  const area=areaSelect.value;
  let csv='line,stations,company,price,area,type,start_time,end_time,color\n';
  parsed.filter(p=>p.area===area).forEach(p=>{
    csv+=`"${p.line}","${p.stations}","${p.company}","${p.price}","${p.area}","${p.type}","${p.start}","${p.end}","${p.color}"\n`;
  });
  download(csv,`bus_${area}.csv`,'text/csv');
}

function exportExcel(){
  const area=areaSelect.value;
  const rows=[['line','stations','company','price','area','type','start_time','end_time','color']];
  parsed.filter(p=>p.area===area).forEach(p=>{
    rows.push([p.line,p.stations,p.company,p.price,p.area,p.type,p.start,p.end,p.color]);
  });
  const ws=XLSX.utils.aoa_to_sheet(rows);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'data');
  const out=XLSX.write(wb,{bookType:'xlsx',type:'array'});
  download(out,`bus_${area}.xlsx`,
    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
}

/* ===== å¯¼å…¥ ===== */
function importFile(file){
  file.name.endsWith('.csv')?importCSV(file):importExcel(file);
}

function importCSV(file){
  const r=new FileReader();
  r.onload=()=>{
    const rows=r.result.split('\n').slice(1)
      .map(l=>l.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g)
      ?.map(s=>s.replace(/^"|"$/g,'')));
    convertRows(rows.map(c=>({
      line:c[0],stations:c[1],company:c[2],price:c[3],
      area:c[4],type:c[5],start_time:c[6],end_time:c[7],color:c[8]
    })));
  };
  r.readAsText(file,'utf-8');
}

function importExcel(file){
  const r=new FileReader();
  r.onload=e=>{
    const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});
    const ws=wb.Sheets[wb.SheetNames[0]];
    const rows=XLSX.utils.sheet_to_json(ws); // âœ… å…³é”®ä¿®å¤
    convertRows(rows);
  };
  r.readAsArrayBuffer(file);
}

/* ===== ç»Ÿä¸€ç”ŸæˆåŸå§‹æ ¼å¼ ===== */
function convertRows(rows){
  output.value='';
  rows.forEach(o=>{
    if(!o.line||!o.stations) return;
    let t=`ã€${o.line}ã€‘${o.stations}-{${o.company||''}}ã€Š${o.price||''}ã€‹ã€${o.area||''}ã€`;
    if(o.type&&o.type!=='å…¬äº¤') t+=`Î¸${o.type}Î¸`;
    t+=`Â§${o.start_time||''}Â§@${o.end_time||''}@`;
    if(o.color) t+=`âˆ®${o.color}âˆ®`;
    output.value+=t+'\n';
  });
}

/* ===== å·¥å…· ===== */
function copyText(){navigator.clipboard.writeText(output.value);}
function downloadTXT(){download(output.value,'bus_converted.txt','text/plain');}
function download(data,name,type){
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([data],{type}));
  a.download=name;
  a.click();
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bus Data Manager</title>

<!-- Material 3 (Material Web) -->
<script type="module" src="https://unpkg.com/@material/web/all.js"></script>

<style>
  body {
    margin: 0;
    font-family: system-ui, -apple-system, BlinkMacSystemFont;
    background: #fef7ff;
    color: #1c1b1f;
  }
  header {
    padding: 24px;
    font-size: 24px;
    font-weight: 600;
  }
  main {
    padding: 16px;
    display: grid;
    gap: 16px;
  }
  md-elevated-card {
    padding: 16px;
    border-radius: 28px;
  }
  .row {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    align-items: center;
  }
  textarea {
    width: 100%;
    min-height: 180px;
    border-radius: 16px;
    padding: 12px;
    border: none;
    background: #f3edf7;
    font-family: monospace;
  }
</style>
</head>

<body>
<header>ğŸšŒ Bus Data Manager</header>

<main>

  <!-- åœ°åŒºé€‰æ‹© -->
  <md-elevated-card>
    <div class="row">
      <md-filled-select id="areaSelect" label="é€‰æ‹©åœ°åŒº"></md-filled-select>
      <md-tonal-button id="exportCSV">å¯¼å‡º CSV</md-tonal-button>
    </div>
  </md-elevated-card>

  <!-- çº¿è·¯åˆ—è¡¨ -->
  <md-elevated-card id="listCard"></md-elevated-card>

  <!-- CSV å¯¼å…¥ / è½¬æ¢ -->
  <md-elevated-card>
    <h3>CSV â†’ åŸå§‹æ ¼å¼</h3>
    <textarea id="csvInput" placeholder="ç²˜è´´ CSV å†…å®¹"></textarea>
    <div class="row">
      <md-filled-button id="convertBtn">è½¬æ¢</md-filled-button>
      <md-tonal-button id="copyBtn">å¤åˆ¶</md-tonal-button>
      <md-tonal-button id="downloadBtn">å¯¼å‡º TXT</md-tonal-button>
      <md-tonal-button id="shareBtn">ç³»ç»Ÿåˆ†äº«</md-tonal-button>
    </div>
    <textarea id="resultOutput" placeholder="è½¬æ¢ç»“æœ"></textarea>
  </md-elevated-card>

</main>

<script>
let allData = [];
let currentArea = '';

/* 1ï¸âƒ£ è‡ªåŠ¨è¯»å– bus_data.txt */
fetch('./data/bus_data.txt')
  .then(r => r.text())
  .then(text => {
    allData = parseRaw(text);
    initAreaSelect();
    renderList();
  });

/* 2ï¸âƒ£ è§£æåŸå§‹æ ¼å¼ */
function parseRaw(text) {
  return text.split('\n').filter(Boolean).map(line => ({
    raw: line,
    line: line.match(/ã€(.*?)ã€‘/)?.[1],
    area: line.match(/ã€(.*?)ã€/)?.[1] || 'æœªçŸ¥',
    company: line.match(/\-\{(.*?)\}/)?.[1],
    first: line.match(/Â§(.*?)Â§/)?.[1],
    last: line.match(/@(.*?)@/)?.[1],
    stops: line.split('ã€‘')[1]?.split('-{')[0]
  }));
}

/* 3ï¸âƒ£ åœ°åŒºä¸‹æ‹‰æ¡† */
function initAreaSelect() {
  const areas = [...new Set(allData.map(d => d.area))];
  const select = document.getElementById('areaSelect');

  areas.forEach(a => {
    const opt = document.createElement('md-select-option');
    opt.value = a;
    opt.textContent = a;
    select.appendChild(opt);
  });

  select.addEventListener('change', e => {
    currentArea = e.target.value;
    renderList();
  });

  currentArea = areas[0];
  select.value = currentArea;
}

/* 4ï¸âƒ£ æ¸²æŸ“çº¿è·¯åˆ—è¡¨ */
function renderList() {
  const box = document.getElementById('listCard');
  box.innerHTML = '';

  allData
    .filter(d => d.area === currentArea)
    .forEach(d => {
      const div = document.createElement('div');
      div.innerHTML = `
        <strong>${d.line}</strong><br>
        ${d.company || ''}<br>
        é¦– ${d.first || '-'} Â· æœ« ${d.last || '-'}
        <hr>
      `;
      box.appendChild(div);
    });
}

/* 5ï¸âƒ£ å¯¼å‡º CSV */
document.getElementById('exportCSV').onclick = () => {
  const rows = allData.filter(d => d.area === currentArea);
  const header = 'line,area,company,stops,first,last\n';
  const body = rows.map(d =>
    `"${d.line}","${d.area}","${d.company}","${d.stops}","${d.first}","${d.last}"`
  ).join('\n');

  download(header + body, 'bus_data.csv');
};

/* 6ï¸âƒ£ CSV â†’ åŸå§‹æ ¼å¼ */
document.getElementById('convertBtn').onclick = () => {
  const text = document.getElementById('csvInput').value;
  const lines = text.split('\n').slice(1);
  const result = lines.map(l => {
    const v = l.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g)
      .map(x => x.replace(/^"|"$/g, ''));
    return `ã€${v[0]}ã€‘${v[3]}-{${v[2]}}ã€Šã€‹ã€${v[1]}ã€Â§${v[4]}Â§@${v[5]}@`;
  }).join('\n');

  document.getElementById('resultOutput').value = result;
};

/* å·¥å…·å‡½æ•° */
function download(text, name) {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([text]));
  a.download = name;
  a.click();
}

document.getElementById('copyBtn').onclick = () =>
  navigator.clipboard.writeText(resultOutput.value);

document.getElementById('downloadBtn').onclick = () =>
  download(resultOutput.value, 'bus_data.txt');

document.getElementById('shareBtn').onclick = () => {
  navigator.share?.({ text: resultOutput.value });
};
</script>
</body>
</html>

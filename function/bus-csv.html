<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>å…¬äº¤ / è½¨é“ æ•°æ®åŒå‘è½¬æ¢å™¨</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

<style>
:root{
  --md-primary:#6750A4;
  --md-surface:#FFFBFE;
  --md-outline:#CAC4D0;
  --md-radius:16px;
}
body{
  margin:0;
  font-family:system-ui,-apple-system;
  background:var(--md-surface);
}
header{
  padding:20px;
  font-size:22px;
  font-weight:600;
}
.card{
  margin:16px;
  padding:16px;
  border-radius:var(--md-radius);
  background:#fff;
  box-shadow:0 1px 6px rgba(0,0,0,.1);
}
select,button,input,textarea{
  width:100%;
  margin-top:10px;
  padding:12px;
  border-radius:12px;
  border:1px solid var(--md-outline);
}
button{
  background:var(--md-primary);
  color:#fff;
  border:none;
}
button.secondary{
  background:#E8DEF8;
  color:#21005D;
}
textarea{
  height:200px;
  font-family:monospace;
}
.row{
  display:flex;
  gap:10px;
}
.row button{flex:1}
#error{
  color:red;
  margin-top:10px;
}
</style>
</head>

<body>
<header>ğŸšŒ å…¬äº¤ / è½¨é“ æ•°æ®åŒå‘è½¬æ¢å™¨</header>

<div class="card">
  <b>â‘  é€‰æ‹©åœ°åŒº</b>
  <select id="areaSelect"></select>
  <div class="row">
    <button onclick="exportCSV()">å¯¼å‡º CSV</button>
    <button onclick="exportExcel()">å¯¼å‡º Excel</button>
  </div>
</div>

<div class="card">
  <b>â‘¡ å¯¼å…¥ CSV / Excel</b>
  <input type="file" accept=".csv,.xlsx" onchange="importFile(this.files[0])">
  <div id="error"></div>
</div>

<div class="card">
  <b>â‘¢ è½¬æ¢ç»“æœ</b>
  <textarea id="output"></textarea>
  <div class="row">
    <button class="secondary" onclick="copyText()">å¤åˆ¶</button>
    <button class="secondary" onclick="downloadTXT()">å¯¼å‡º TXT</button>
  </div>
</div>

<script>
let parsed=[];

/* ===== è¯»å–åŸå§‹æ•°æ®åº“ ===== */
fetch('../data/bus_data.txt')
.then(r=>r.text())
.then(t=>{
  const lines=t.split(/\n+/).filter(l=>l.trim());
  const areas=new Set();

  lines.forEach(l=>{
    const area=l.match(/ã€(.+?)ã€/)?.[1]||'æœªçŸ¥';
    areas.add(area);
  });

  areaSelect.innerHTML=[...areas].map(a=>`<option>${a}</option>`).join('');
});

/* ===== å¯¼å‡º CSV ===== */
function exportCSV(){
  const area=areaSelect.value;
  let csv='line,stations,company,price,area,type,start_time,end_time,color\n';
  parsed.filter(p=>p.area===area).forEach(p=>{
    csv+=`${Object.values(p).map(v=>`"${v||''}"`).join(',')}\n`;
  });
  download(csv,`bus_${area}.csv`,'text/csv');
}

/* ===== å¯¼å‡º Excel ===== */
function exportExcel(){
  const area=areaSelect.value;
  const rows=[['line','stations','company','price','area','type','start_time','end_time','color']];
  parsed.filter(p=>p.area===area).forEach(p=>{
    rows.push(Object.values(p));
  });
  const ws=XLSX.utils.aoa_to_sheet(rows);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'data');
  XLSX.writeFile(wb,`bus_${area}.xlsx`);
}

/* ===== å¯¼å…¥å…¥å£ ===== */
function importFile(file){
  error.textContent='';
  if(file.name.endsWith('.xlsx')){
    importExcel(file);
  }else if(file.name.endsWith('.csv')){
    importCSV(file);
  }else{
    error.textContent='âŒ ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹';
  }
}

/* ===== Excel è½¬ CSV å†è§£æ ===== */
function importExcel(file){
  const reader=new FileReader();
  reader.onload=e=>{
    const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});
    const ws=wb.Sheets[wb.SheetNames[0]];
    const rows=XLSX.utils.sheet_to_json(ws,{header:1});
    parseTable(rows);
  };
  reader.readAsArrayBuffer(file);
}

/* ===== CSV è§£æ ===== */
function importCSV(file){
  const reader=new FileReader();
  reader.onload=e=>{
    const rows=e.target.result.split('\n')
      .map(r=>r.split(',').map(c=>c.replace(/^"|"$/g,'')));
    parseTable(rows);
  };
  reader.readAsText(file,'utf-8');
}

/* ===== æ ¸å¿ƒè§£æï¼ˆå®¹é”™ï¼‰ ===== */
function parseTable(rows){
  if(!rows.length){ error.textContent='âŒ æ–‡ä»¶ä¸ºç©º'; return; }

  const header=rows[0].map(h=>h.trim().toLowerCase());

  const required=['line','stations','company','area'];
  for(let r of required){
    if(!header.includes(r)){
      error.textContent=`âŒ ç¼ºå°‘å¿…è¦å­—æ®µï¼š${r}`;
      return;
    }
  }

  const index={};
  header.forEach((h,i)=>index[h]=i);

  parsed=[];
  let outputText='';

  rows.slice(1).forEach((row,i)=>{
    if(!row || row.every(c=>!c.trim())) return;

    const get=k=>row[index[k]]?.trim()||'';

    const obj={
      line:get('line'),
      stations:get('stations'),
      company:get('company'),
      price:get('price'),
      area:get('area'),
      type:get('type')||'å…¬äº¤',
      start_time:get('start_time'),
      end_time:get('end_time'),
      color:get('color')
    };

    parsed.push(obj);

    let txt=`ã€${obj.line}ã€‘${obj.stations}-{${obj.company}}ã€Š${obj.price}ã€‹ã€${obj.area}ã€`;
    if(obj.type && obj.type!=='å…¬äº¤') txt+=`Î¸${obj.type}Î¸`;
    txt+=`Â§${obj.start_time}Â§@${obj.end_time}@`;
    if(obj.color) txt+=`âˆ®${obj.color}âˆ®`;

    outputText+=txt+'\n';
  });

  output.value=outputText;
}

/* ===== å·¥å…· ===== */
function copyText(){navigator.clipboard.writeText(output.value);}
function downloadTXT(){download(output.value,'bus_converted.txt','text/plain');}
function download(data,name,type){
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([data],{type}));
  a.download=name;
  a.click();
}
</script>
</body>
</html>
